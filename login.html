<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Rivava Finance</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-dark: #000000;
            --card-dark: #0d0d0d;
            --accent: #00ffc3;
            --accent-glow: rgba(0, 255, 195, 0.2);
            --text: #f0f0f0;
            --muted: #888;
            --danger: #ff5252;
            --border-color: #1a1a1a;
            --brand-pink: #f82a99;
            --brand-blue: #2aa1f8;
        }
        
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Background Effects */
        .background-glow {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; overflow: hidden;
        }
        .shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.15;
        }
        .shape-1 { width: 400px; height: 400px; background: var(--brand-pink); top: 10%; left: 10%; animation: move 20s infinite alternate ease-in-out; }
        .shape-2 { width: 350px; height: 350px; background: var(--brand-blue); bottom: 5%; right: 5%; animation: move 25s infinite alternate-reverse ease-in-out; }
        
        @keyframes move {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(50px, -50px) scale(1.1); }
        }

        /* Login Card */
        .login-wrapper { position: relative; z-index: 2; width: 100%; display: flex; justify-content: center; padding: 20px; }
        .login-container {
            text-align: center; padding: 40px;
            background: rgba(13, 13, 13, 0.7);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%; max-width: 400px;
            transition: all 0.5s ease;
        }
        .login-container.hidden { opacity: 0; transform: scale(0.9); pointer-events: none; }
        
        .logo { width: 80px; height: 80px; border-radius: 12px; margin-bottom: 20px; }
        h1 { font-size: 2rem; margin-bottom: 10px; background: linear-gradient(90deg, var(--accent), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { color: var(--muted); margin-bottom: 30px; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--card-dark); padding: 30px; border-radius: 16px;
            border: 1px solid #222; width: 90%; max-width: 420px;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }

        /* Forms */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; }
        input, select {
            width: 100%; padding: 12px; border-radius: 8px;
            background: #050505; border: 1px solid #222; color: #fff;
            font-family: inherit;
        }
        .phone-input-container { display: flex; }
        .phone-prefix { padding: 12px; background: #222; border: 1px solid #222; border-radius: 8px 0 0 8px; }
        .phone-input-container input { border-radius: 0 8px 8px 0; }
        
        button {
            width: 100%; padding: 14px; background: var(--accent);
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            margin-top: 10px; transition: 0.2s;
        }
        button:disabled { background: #444; cursor: not-allowed; }

        /* Welcome Screen */
        #welcomeScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 2000;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
        }
        #welcomeScreen.show { opacity: 1; pointer-events: auto; }
        .welcome-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); }
        .welcome-avatar-initials { 
            width: 120px; height: 120px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: #000; font-weight: bold;
        }
        .error-message { color: var(--danger); font-size: 0.8rem; margin-top: 5px; display: none; }
    </style>
</head>
<body>

    <div class="background-glow">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
    </div>

    <div class="login-wrapper">
        <div class="login-container" id="loginContainer">
            <img src="./logo.png" alt="Rivava Logo" class="logo" onerror="this.src='https://placehold.co/100x100/000000/00ffc3?text=R'">
            <h1>Welcome to Rivava</h1>
            <p>Sign in to begin your financial journey.</p>
            <div id="g_id_signin_container"></div>
        </div>
    </div>

    <div id="registrationModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="registration-title" style="text-align:center; color:var(--accent)">Complete Your Profile</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="userNameInput" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label>Mobile Number</label>
                <div class="phone-input-container">
                    <span class="phone-prefix">+91</span>
                    <input type="tel" id="phoneInput" placeholder="10-digit number" maxlength="10">
                </div>
                <p id="phone-error-message" class="error-message"></p>
            </div>
            <div class="form-group">
                <label>Gender</label>
                <select id="genderInput">
                    <option value="" disabled selected>Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <button id="completeRegistrationBtn" onclick="completeRegistration()">Save & Continue</button>
            <p id="general-error-message" class="error-message" style="text-align:center"></p>
        </div>
    </div>

    <div id="welcomeScreen">
        <div id="welcomeAvatarContainer"></div>
        <h2 id="welcomeText" style="margin-top:20px"></h2>
        <p id="welcomeSubText">Your journey starts now.</p>
    </div>

    <script>
        const GOOGLE_CLIENT_ID = "151251461452-tdkaqdi20tbe3vcu31e1nv8m6ruukr46.apps.googleusercontent.com";
        const firebaseConfig = { 
            apiKey: "AIzaSyAEB3DSSIWATjfcbmkO094GsO56paxrDhU", 
            authDomain: "rivava-finance-tracker.firebaseapp.com", 
            projectId: "rivava-finance-tracker", 
            storageBucket: "rivava-finance-tracker.appspot.com", 
            messagingSenderId: "615077199032", 
            appId: "1:615077199032:web:fb2007f8a603fa8abcc84d" 
        };

        let db;
        let currentUserData = null;

        // 1. Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();

        // 2. Google Login Init
        function initGoogleSignIn() {
            if (window.google && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse
                });
                google.accounts.id.renderButton(
                    document.getElementById('g_id_signin_container'),
                    { theme: 'outline', size: 'large', shape: 'rounded' }
                );
            } else {
                setTimeout(initGoogleSignIn, 500);
            }
        }

        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            } catch (e) { return null; }
        }

        async function handleCredentialResponse(response) {
            const payload = parseJwt(response.credential);
            if (!payload) return;

            currentUserData = {
                name: payload.name,
                email: payload.email,
                picture: payload.picture,
                sub: payload.sub
            };

            document.getElementById('loginContainer').classList.add('hidden');
            const userRef = db.collection('users').doc(currentUserData.sub);

            try {
                const userDoc = await userRef.get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.phone && userData.gender) {
                        // Existing complete user
                        await userRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                        proceedToApp({...currentUserData, ...userData});
                    } else {
                        // User exists but incomplete
                        showModal(userData);
                    }
                } else {
                    // New User
                    showModal();
                }
            } catch (e) {
                console.error("Login Error:", e);
            }
        }

        function showModal(data = {}) {
            document.getElementById('userNameInput').value = data.name || currentUserData.name;
            if (data.phone) document.getElementById('phoneInput').value = data.phone.replace('+91', '');
            document.getElementById('registrationModal').classList.add('show');
        }

        async function completeRegistration() {
            const name = document.getElementById('userNameInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const gender = document.getElementById('genderInput').value;
            const btn = document.getElementById('completeRegistrationBtn');

            if (!name || phone.length !== 10 || !gender) {
                document.getElementById('general-error-message').textContent = "Please fill all fields.";
                document.getElementById('general-error-message').style.display = "block";
                return;
            }

            btn.disabled = true;
            btn.textContent = "Saving...";

            const userRef = db.collection('users').doc(currentUserData.sub);
            const finalData = {
                name, email: currentUserData.email, picture: currentUserData.picture,
                phone: `+91${phone}`, gender, lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await userRef.set(finalData, { merge: true });
                proceedToApp(finalData);
            } catch (e) {
                btn.disabled = false;
                btn.textContent = "Save & Continue";
            }
        }

        function proceedToApp(user) {
            document.getElementById('registrationModal').classList.remove('show');
            
            // Show Animation
            const container = document.getElementById('welcomeAvatarContainer');
            container.innerHTML = user.picture ? 
                `<img src="${user.picture}" class="welcome-avatar">` : 
                `<div class="welcome-avatar-initials" style="background:var(--accent)">${user.name[0]}</div>`;
            
            document.getElementById('welcomeText').textContent = `Welcome, ${user.name.split(' ')[0]}!`;
            document.getElementById('welcomeScreen').classList.add('show');

            localStorage.setItem('rivava_user', JSON.stringify(user));
            
            setTimeout(() => {
                window.location.href = './index.html';
            }, 2500);
        }

        window.onload = () => {
            if (localStorage.getItem('rivava_user')) {
                window.location.href = './index.html';
            } else {
                initGoogleSignIn();
            }
        };
    </script>
</body>
</html>
