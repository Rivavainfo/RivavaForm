<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard | Rivava Finance</title>

<!-- App Icons (uses your folder: icons_folder) -->
<link rel="icon" type="image/png" sizes="32x32" href="./icons_folder/icon-32x32.png">
<link rel="apple-touch-icon" href="./icons_folder/icon-180x180.png">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


<style>
  :root{
    --bg-dark:#000;
    --card-dark:#0d0d0d;
    --accent:#00ffc3;
    --accent-glow: rgba(0, 255, 195, 0.2);
    --text:#fff;
    --muted:#888;
    --danger: #ff5252;
    --warning: #feca57;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background:var(--bg-dark);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
  }
  
  /* Header */
  .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background-color: var(--card-dark);
      border-bottom: 1px solid #1a1a1a;
      position: sticky;
      top: 0;
      z-index: 100;
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .back-btn {
      background: none; border: none; color: var(--text);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease;
  }
  .back-btn:hover { color: var(--accent); }
  .back-btn svg { width: 24px; height: 24px; }
  .history-header h2 { margin: 0; font-size: 1.2rem; }
  
  /* Main Content */
  .history-content { padding: 24px; max-width: 1200px; margin: 0 auto; }
  
  /* Controls Bar: Filters and View Selector */
  .controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 24px;
  }

  .filter-pills {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
      flex-grow: 1;
  }
  .filter-pills button {
      background: #222;
      border: 1px solid #333;
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 99px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
  }
  .filter-pills button.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      box-shadow: 0 0 15px var(--accent-glow);
  }
  #customDateFilter { display: none; gap: 10px; align-items: center; }
  #customDateFilter input { background: #222; border: 1px solid #333; color: var(--text); padding: 8px; border-radius: 8px; }

  .view-selector select {
    background: #222;
    border: 1px solid #333;
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  
  /* Views Container */
  .view { display: none; }
  .view.active { display: block; animation: viewFadeIn 0.5s ease; }
  @keyframes viewFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; translateY(0); } }

  /* Dashboard View */
  .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
  }
  .summary-card {
      background: var(--card-dark);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #1a1a1a;
  }
  .summary-card .title {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 8px;
  }
  .summary-card .value {
      font-size: 1.8rem;
      font-weight: 700;
  }
  .summary-card .value.spent { color: var(--danger); }
  .summary-card .value.earned { color: var(--accent); }

  .chart-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .chart-container {
      background: var(--card-dark);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #1a1a1a;
      height: 400px;
  }

  /* Transactions View */
  .table-container{overflow-x:auto; border-radius:12px;border: 1px solid #1a1a1a;}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:12px 15px;border-bottom:1px solid #222;text-align:left;}
  th{color:var(--accent);font-weight:700;font-size:0.9rem;background: rgba(255,255,255,0.02);}
  td{font-size:0.9rem;}
  .transaction-type { font-weight: 600; }
  .transaction-type.Expense { color: var(--danger); }
  .transaction-type.Earning { color: var(--accent); }

  /* Analysis View */
  .analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
  }
  .analysis-card {
    background: var(--card-dark);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #1a1a1a;
  }
  .analysis-card h3 { margin-top: 0; color: var(--accent); }
  .analysis-card .metric { font-size: 2.5rem; font-weight: 700; margin: 10px 0; }
  .analysis-card .insight { font-size: 0.9rem; color: var(--muted); line-height: 1.5; }
  #top-expenses-chart-container { height: 300px; }


  #historyLoader, #noHistoryMessage { text-align: center; padding: 40px; color: var(--muted); font-size: 1.1rem; }

  @media(max-width: 900px) {
    .chart-grid { grid-template-columns: 1fr; }
  }
  @media(max-width: 768px) {
    .controls-bar { flex-direction: column; align-items: stretch; }
    .history-content { padding: 16px; }
  }
</style>
</head>
<body>

<header class="history-header">
    <div class="header-left">
        <button class="back-btn" onclick="goBack()" aria-label="Go Back">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </button>
        <h2>Dashboard</h2>
    </div>
    <div class="view-selector">
        <select id="viewSelector" onchange="switchView(this.value)">
            <option value="dashboard">Dashboard View</option>
            <option value="transactions">Transactions View</option>
            <option value="analysis">Detailed Analysis</option>
        </select>
    </div>
</header>
<div class="history-content">
    <div class="controls-bar">
        <div class="filter-pills" id="filterPills">
            <button class="active" data-filter="today">Today</button>
            <button data-filter="yesterday">Yesterday</button>
            <button data-filter="week">This Week</button>
            <button data-filter="month">This Month</button>
            <button data-filter="custom">Custom Range</button>
        </div>
        <div id="customDateFilter">
            <input type="date" id="startDate">
            <input type="date" id="endDate">
        </div>
    </div>
    
    <div id="historyLoader">Loading your dashboard...</div>
    <div id="noHistoryMessage" style="display: none;">You have no transactions for this period.</div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="view active">
        <div class="summary-cards">
            <div class="summary-card">
                <div class="title" id="spentTitle">Spent Today</div>
                <div class="value spent" id="totalSpent">₹0.00</div>
            </div>
            <div class="summary-card">
                <div class="title" id="earnedTitle">Earned Today</div>
                <div class="value earned" id="totalEarned">₹0.00</div>
            </div>
            <div class="summary-card">
                <div class="title">Net Flow</div>
                <div class="value" id="netFlow">₹0.00</div>
            </div>
        </div>
        <div class="chart-grid">
            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="flowChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Transactions View -->
    <div id="transactionsView" class="view">
        <div class="table-container">
            <table id="transactionsTable">
                <thead>
                    <tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Payment</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Analysis View -->
    <div id="analysisView" class="view">
        <div class="analysis-grid">
            <div class="analysis-card">
                <h3>Savings Rate</h3>
                <div class="metric" id="savingsRate">0%</div>
                <p class="insight">This is the percentage of your earnings that you're saving. A higher number is better!</p>
            </div>
            <div class="analysis-card">
                <h3>Earning vs. Expense</h3>
                <div class="metric" id="earningVsExpense">₹0 / ₹0</div>
                <p class="insight">A direct comparison of your total income and spending for the selected period.</p>
            </div>
            <div class="analysis-card" style="grid-column: 1 / -1;">
                <h3>Top Spending Categories</h3>
                <div id="top-expenses-chart-container">
                    <canvas id="topExpensesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let allTransactions = [];
let charts = {};

const firebaseConfig = { apiKey: "AIzaSyAEB3DSSIWATjfcbmkO094GsO56paxrDhU", authDomain: "rivava-finance-tracker.firebaseapp.com", projectId: "rivava-finance-tracker", storageBucket: "rivava-finance-tracker.appspot.com", messagingSenderId: "615077199032", appId: "1:615077199032:web:fb2007f8a603fa8abcc84d" };
let db;
try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch (error) { console.error("Firebase Init Error:", error); }

function goBack() { window.location.href = './index.html'; }

function switchView(viewName) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(`${viewName}View`).classList.add('active');
    // Re-render charts if switching to a view that has them, as they might not have been initialized if the view was hidden
    if(viewName === 'dashboard' || viewName === 'analysis') {
        updateDashboard(document.querySelector('#filterPills button.active').dataset.filter);
    }
}

async function fetchTransactions() {
    const loader = document.getElementById('historyLoader');
    const noHistoryMessage = document.getElementById('noHistoryMessage');
    
    loader.style.display = 'block';
    noHistoryMessage.style.display = 'none';

    const user = JSON.parse(localStorage.getItem('rivava_user'));
    if (!user || !user.email) {
        loader.style.display = 'none';
        noHistoryMessage.textContent = 'Please sign in to view your history.';
        noHistoryMessage.style.display = 'block';
        setTimeout(() => { goBack(); }, 2000);
        return;
    }

    try {
        const querySnapshot = await db.collection("submissions").where("userEmail", "==", user.email).orderBy("submittedAt", "desc").get();
        let transactions = [];
        querySnapshot.forEach(doc => {
            const data = doc.data();
            if (data.transactions) {
                transactions = transactions.concat(data.transactions);
            }
        });

        allTransactions = transactions.map(t => {
            const [day, month, year] = t.date.split('/');
            const timeStr = t.time.replace(/(\d{2}:\d{2}:\d{2}) (AM|PM)/, (match, time, period) => {
                let [h, m, s] = time.split(':');
                if (period === 'PM' && h !== '12') h = +h + 12;
                if (period === 'AM' && h === '12') h = '00';
                return `${h}:${m}:${s}`;
            });
            t.jsDate = new Date(`${year}-${month}-${day}T${timeStr}`);
            return t;
        }).sort((a, b) => b.jsDate - a.jsDate); // Sort newest first
        
        updateDashboard('today');

    } catch (error) {
        console.error("Error fetching history:", error);
        noHistoryMessage.textContent = 'Could not load your history.';
        noHistoryMessage.style.display = 'block';
    } finally {
        loader.style.display = 'none';
    }
}

function updateDashboard(filter) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let startDate, endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1); // up to the end of today

    switch(filter) {
        case 'yesterday':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 1);
            endDate = new Date(today);
            break;
        case 'week':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay());
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        case 'custom':
            startDate = new Date(document.getElementById('startDate').value);
            endDate = new Date(document.getElementById('endDate').value);
            endDate.setDate(endDate.getDate() + 1); // include the whole end day
            break;
        case 'today':
        default:
            startDate = today;
            break;
    }

    const filteredTransactions = allTransactions.filter(t => t.jsDate >= startDate && t.jsDate < endDate);
    noHistoryMessage.style.display = filteredTransactions.length === 0 ? 'block' : 'none';

    // Update all views
    updateSummaryCards(filteredTransactions, filter);
    updateTransactionTable(filteredTransactions);
    updateAnalysisView(filteredTransactions);
    
    // Update charts for dashboard view
    const expenseData = groupByCategory(filteredTransactions.filter(t => t.type === 'Expense'));
    renderDoughnutChart('expenseChart', 'Expense Categories', expenseData);
    
    const flowData = groupByDate(filteredTransactions);
    renderLineChart('flowChart', 'Cash Flow', flowData);
}

function updateSummaryCards(transactions, filter) {
    let totalSpent = 0, totalEarned = 0;
    transactions.forEach(t => {
        if (t.type === 'Expense') totalSpent += t.amount;
        if (t.type === 'Earning') totalEarned += t.amount;
    });
    
    const periodText = filter.charAt(0).toUpperCase() + filter.slice(1);
    document.getElementById('spentTitle').textContent = `Spent ${periodText}`;
    document.getElementById('earnedTitle').textContent = `Earned ${periodText}`;
    document.getElementById('totalSpent').textContent = `₹${totalSpent.toFixed(2)}`;
    document.getElementById('totalEarned').textContent = `₹${totalEarned.toFixed(2)}`;
    
    const netFlow = totalEarned - totalSpent;
    const netFlowEl = document.getElementById('netFlow');
    netFlowEl.textContent = `₹${netFlow.toFixed(2)}`;
    netFlowEl.style.color = netFlow >= 0 ? 'var(--accent)' : 'var(--danger)';
}

function updateTransactionTable(transactions) {
    const tbody = document.querySelector('#transactionsTable tbody');
    tbody.innerHTML = '';
    transactions.forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${t.jsDate.toLocaleDateString()}</td>
            <td><span class="transaction-type ${t.type}">${t.type}</span></td>
            <td>${t.category}</td>
            <td>₹${t.amount.toFixed(2)}</td>
            <td>${t.payment}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateAnalysisView(transactions) {
    let totalSpent = 0, totalEarned = 0;
    transactions.forEach(t => {
        if (t.type === 'Expense') totalSpent += t.amount;
        if (t.type === 'Earning') totalEarned += t.amount;
    });

    const savingsRate = totalEarned > 0 ? ((totalEarned - totalSpent) / totalEarned) * 100 : 0;
    document.getElementById('savingsRate').textContent = `${savingsRate.toFixed(1)}%`;
    document.getElementById('earningVsExpense').textContent = `₹${totalEarned.toFixed(2)} / ₹${totalSpent.toFixed(2)}`;

    const topExpenseData = groupByCategory(transactions.filter(t => t.type === 'Expense'));
    renderBarChart('topExpensesChart', 'Top Expenses', topExpenseData);
}

// Helper functions for data processing
function groupByCategory(transactions) {
    return transactions.reduce((acc, t) => {
        acc[t.category] = (acc[t.category] || 0) + t.amount;
        return acc;
    }, {});
}

function groupByDate(transactions) {
    const data = transactions.reduce((acc, t) => {
        const date = t.jsDate.toISOString().split('T')[0];
        if (!acc[date]) {
            acc[date] = { earned: 0, spent: 0 };
        }
        if (t.type === 'Earning') acc[date].earned += t.amount;
        if (t.type === 'Expense') acc[date].spent += t.amount;
        return acc;
    }, {});
    return Object.entries(data).map(([date, values]) => ({ x: date, ...values }));
}


// Chart Rendering Functions
function renderDoughnutChart(canvasId, label, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    
    if(Object.keys(data).length === 0) return;

    charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data),
            datasets: [{
                label: label,
                data: Object.values(data),
                backgroundColor: ['#00ffc3', '#ff6b6b', '#4d94ff', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd', '#c8d6e5'],
                borderColor: '#0d0d0d', borderWidth: 4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#fff', font: { family: "'Poppins', sans-serif" } } } }
        }
    });
}

function renderLineChart(canvasId, label, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    
    if(data.length === 0) return;

    charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                { label: 'Earned', data: data.map(d => ({x: d.x, y: d.earned})), borderColor: 'var(--accent)', tension: 0.1 },
                { label: 'Spent', data: data.map(d => ({x: d.x, y: d.spent})), borderColor: 'var(--danger)', tension: 0.1 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { type: 'time', time: { unit: 'day' }, ticks: { color: 'var(--muted)' }, grid: { color: '#222' } },
                y: { ticks: { color: 'var(--muted)' }, grid: { color: '#222' } }
            },
            plugins: { legend: { labels: { color: '#fff' } } }
        }
    });
}

function renderBarChart(canvasId, label, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    
    if(Object.keys(data).length === 0) return;

    const sortedData = Object.entries(data).sort(([,a],[,b]) => b-a);

    charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedData.map(item => item[0]),
            datasets: [{
                label: label,
                data: sortedData.map(item => item[1]),
                backgroundColor: ['#00ffc3', '#ff6b6b', '#4d94ff', '#feca57', '#ff9ff3'],
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: 'var(--muted)' }, grid: { color: '#222' } },
                y: { ticks: { color: 'var(--muted)' }, grid: { color: 'transparent' } }
            }
        }
    });
}


// Event Listeners
document.getElementById('filterPills').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
        document.querySelectorAll('#filterPills button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        const filter = e.target.dataset.filter;
        document.getElementById('customDateFilter').style.display = filter === 'custom' ? 'flex' : 'none';
        if (filter !== 'custom') {
            updateDashboard(filter);
        }
    }
});

document.getElementById('customDateFilter').addEventListener('change', () => {
    updateDashboard('custom');
});

window.addEventListener('load', fetchTransactions);
</script>

</body>
</html>
