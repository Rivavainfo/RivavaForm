<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard | Rivava Finance</title>

<!-- App Icons -->
<link rel="icon" type="image/png" sizes="32x32" href="./icons_folder/icon-32x32.png">
<link rel="apple-touch-icon" href="./icons_folder/icon-180x180.png">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg-dark:#050505; /* Slightly lighter black */
    --card-dark:#0d0d0d;
    --accent:#00ffc3;
    --accent-glow: rgba(0, 255, 195, 0.2);
    --text:#fff;
    --muted:#888;
    --danger: #ff5252;
    --warning: #feca57;
  }
  *{box-sizing:border-box}
  html { -webkit-tap-highlight-color: transparent; }
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background:var(--bg-dark);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    overscroll-behavior-y: contain;
  }
  
  /* Header */
  .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background-color: var(--card-dark);
      border-bottom: 1px solid #1a1a1a;
      position: sticky;
      top: 0;
      z-index: 100;
  }
  .header-left { display: flex; align-items: center; gap: 8px; }
  .header-title { margin: 0; font-size: 1.2rem; }
  .action-btn {
      background: #222;
      border: 1px solid #333;
      color: var(--text);
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
  }
  .action-btn:hover { background-color: #333; border-color: var(--accent); }
  .action-btn svg { width: 18px; height: 18px; }
  
  /* Main Content */
  .dashboard-content { padding: 16px; max-width: 1200px; margin: 0 auto; }
  
  .filter-pills {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      overflow-x: auto;
      padding-bottom: 10px;
      -ms-overflow-style: none; scrollbar-width: none;
  }
  .filter-pills::-webkit-scrollbar { display: none; }
  .filter-pills button {
      background: #222; border: 1px solid #333; color: var(--muted);
      padding: 8px 16px; border-radius: 99px; font-weight: 600;
      cursor: pointer; transition: all 0.2s ease; white-space: nowrap; font-size: 0.9rem;
  }
  .filter-pills button.active {
      background: var(--accent); color: #000; border-color: var(--accent);
      box-shadow: 0 0 15px var(--accent-glow);
  }
  
  /* Grid Layout */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .card {
    background: var(--card-dark);
    padding: 20px;
    border-radius: 16px;
    border: 1px solid #1a1a1a;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }
  .card-title {
    margin: 0 0 16px 0;
    font-size: 1.1rem;
    color: var(--text);
    font-weight: 600;
  }

  /* Summary Cards */
  .summary-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
  }
  .summary-card .label {
      font-size: 0.85rem; color: var(--muted); margin-bottom: 8px;
  }
  .summary-card .value {
      font-size: 1.8rem; font-weight: 700;
  }
  .summary-card .value.earned { color: var(--accent); }
  .summary-card .value.spent { color: var(--danger); }

  /* Health Gauge */
  .health-gauge-container { position: relative; height: 180px; }
  #healthGauge { width: 100% !important; height: 100% !important; }

  /* Top Spending List */
  .spending-list { list-style: none; padding: 0; margin: 0; }
  .spending-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #1a1a1a; }
  .spending-item:last-child { border-bottom: none; }
  .spending-info { display: flex; flex-direction: column; }
  .spending-category { font-weight: 600; }
  .spending-percentage { font-size: 0.8rem; color: var(--muted); }
  .spending-amount { font-weight: 700; font-size: 1.1rem; }

  #loader, #no-data { text-align: center; padding: 40px; color: var(--muted); font-size: 1.1rem; }

  @media(min-width: 768px) {
    .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
    .dashboard-content { padding: 24px; }
  }
  @media(min-width: 1024px) {
    .dashboard-grid { grid-template-columns: repeat(3, 1fr); }
    .card.full-span { grid-column: 1 / -1; }
  }
</style>
</head>
<body>

<header class="header">
    <div class="header-left">
        <a href="./index.html" class="action-btn" aria-label="Go Back">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </a>
        <h2 class="header-title">Dashboard</h2>
    </div>
    <a href="./analysis.html" class="action-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
        <span>Detailed Analysis</span>
    </a>
</header>

<main class="dashboard-content">
    <div class="filter-pills" id="filterPills">
        <button class="active" data-filter="today">Today</button>
        <button data-filter="week">This Week</button>
        <button data-filter="month">This Month</button>
        <button data-filter="all">All Time</button>
    </div>
    
    <div id="loader">Loading your dashboard...</div>
    <div id="no-data" style="display: none;">No transaction data found for this period.</div>

    <div class="dashboard-grid" id="dashboardGrid" style="display: none;">
        <div class="card summary-card">
            <div class="label" id="earnedTitle">Total Earned</div>
            <div class="value earned" id="totalEarned">₹0</div>
        </div>
        <div class="card summary-card">
            <div class="label" id="spentTitle">Total Spent</div>
            <div class="value spent" id="totalSpent">₹0</div>
        </div>
        
        <div class="card">
            <h3 class="card-title">Financial Health</h3>
            <div class="health-gauge-container">
                <canvas id="healthGauge"></canvas>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">Top Spending</h3>
            <ul class="spending-list" id="topSpendingList">
                <!-- Items will be injected by JS -->
            </ul>
        </div>

        <div class="card full-span">
            <h3 class="card-title">Income vs. Expense</h3>
            <div style="height: 300px;">
                <canvas id="flowChart"></canvas>
            </div>
        </div>
    </div>
</main>

<script>
let allTransactions = [];
let charts = {};

const firebaseConfig = { apiKey: "AIzaSyAEB3DSSIWATjfcbmkO094GsO56paxrDhU", authDomain: "rivava-finance-tracker.firebaseapp.com", projectId: "rivava-finance-tracker", storageBucket: "rivava-finance-tracker.appspot.com", messagingSenderId: "615077199032", appId: "1:615077199032:web:fb2007f8a603fa8abcc84d" };
let db;
try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch (error) { console.error("Firebase Init Error:", error); }

async function fetchTransactions() {
    const loader = document.getElementById('loader');
    const noData = document.getElementById('no-data');
    const grid = document.getElementById('dashboardGrid');

    loader.style.display = 'block';
    noData.style.display = 'none';
    grid.style.display = 'none';

    const user = JSON.parse(localStorage.getItem('rivava_user'));
    if (!user || !user.email) {
        loader.style.display = 'none';
        noData.textContent = 'Please sign in to view your dashboard.';
        noData.style.display = 'block';
        setTimeout(() => { window.location.href = './index.html'; }, 2000);
        return;
    }

    try {
        const querySnapshot = await db.collection("submissions").where("userEmail", "==", user.email).get();
        let transactions = [];
        querySnapshot.forEach(doc => {
            const data = doc.data();
            if (data.transactions) {
                transactions = transactions.concat(data.transactions);
            }
        });

        allTransactions = transactions.map(t => {
            const [day, month, year] = t.date.split('/');
            const timeStr = t.time.replace(/(\d{2}:\d{2}:\d{2}) (AM|PM)/, (match, time, period) => {
                let [h, m, s] = time.split(':');
                if (period === 'PM' && h !== '12') h = +h + 12;
                if (period === 'AM' && h === '12') h = '00';
                return `${h}:${m}:${s}`;
            });
            t.jsDate = new Date(`${year}-${month}-${day}T${timeStr}`);
            return t;
        });
        
        updateUI('today');
        loader.style.display = 'none';
        grid.style.display = 'grid';

    } catch (error) {
        console.error("Error fetching history:", error);
        loader.style.display = 'none';
        noData.textContent = 'Could not load your history.';
        noData.style.display = 'block';
    }
}

function updateUI(filter) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let startDate;

    switch(filter) {
        case 'week':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay());
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        case 'all':
            startDate = new Date(0);
            break;
        case 'today':
        default:
            startDate = today;
            break;
    }

    const filteredTransactions = allTransactions.filter(t => t.jsDate >= startDate);
    document.getElementById('no-data').style.display = filteredTransactions.length === 0 ? 'block' : 'none';
    document.getElementById('dashboardGrid').style.display = filteredTransactions.length > 0 ? 'grid' : 'none';

    if(filteredTransactions.length === 0) return;

    let totalSpent = 0, totalEarned = 0;
    const expenseByCategory = {};

    filteredTransactions.forEach(t => {
        if (t.type === 'Expense') {
            totalSpent += t.amount;
            expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
        }
        if (t.type === 'Earning') totalEarned += t.amount;
    });

    // Update Summary Cards
    const periodText = filter.charAt(0).toUpperCase() + filter.slice(1);
    document.getElementById('earnedTitle').textContent = `Earned ${periodText}`;
    document.getElementById('spentTitle').textContent = `Spent ${periodText}`;
    document.getElementById('totalEarned').textContent = `₹${totalEarned.toLocaleString('en-IN')}`;
    document.getElementById('totalSpent').textContent = `₹${totalSpent.toLocaleString('en-IN')}`;

    // Update Top Spending
    const topSpendingList = document.getElementById('topSpendingList');
    topSpendingList.innerHTML = '';
    const sortedExpenses = Object.entries(expenseByCategory).sort(([,a],[,b]) => b-a).slice(0, 3);
    sortedExpenses.forEach(([category, amount]) => {
        const percentage = totalSpent > 0 ? ((amount / totalSpent) * 100).toFixed(0) : 0;
        const li = document.createElement('li');
        li.className = 'spending-item';
        li.innerHTML = `
            <div class="spending-info">
                <span class="spending-category">${category}</span>
                <span class="spending-percentage">${percentage}% of total spending</span>
            </div>
            <span class="spending-amount">₹${amount.toLocaleString('en-IN')}</span>`;
        topSpendingList.appendChild(li);
    });

    // Render Charts
    const savingsRate = totalEarned > 0 ? ((totalEarned - totalSpent) / totalEarned) * 100 : 0;
    renderGaugeChart(savingsRate);
    renderFlowChart(totalEarned, totalSpent);
}

function renderGaugeChart(value) {
    const canvasId = 'healthGauge';
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();

    const data = {
        labels: ['Savings Rate'],
        datasets: [{
            data: [value, 100 - value],
            backgroundColor: [value > 50 ? '#00ffc3' : value > 20 ? '#feca57' : '#ff5252', '#1a1a1a'],
            borderWidth: 0,
            circumference: 180,
            rotation: 270,
        }]
    };
    charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                tooltip: { enabled: false },
                legend: { display: false }
            },
            cutout: '80%'
        }
    });
}

function renderFlowChart(earned, spent) {
    const canvasId = 'flowChart';
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    
    charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Flow'],
            datasets: [
                { label: 'Earned', data: [earned], backgroundColor: 'rgba(0, 255, 195, 0.7)' },
                { label: 'Spent', data: [spent], backgroundColor: 'rgba(255, 82, 82, 0.7)' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: 'var(--muted)' }, grid: { color: '#222' } },
                x: { ticks: { color: 'var(--muted)' }, grid: { display: false } }
            },
            plugins: { legend: { labels: { color: '#fff' } } }
        }
    });
}

document.getElementById('filterPills').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
        document.querySelectorAll('#filterPills button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        updateUI(e.target.dataset.filter);
    }
});

window.addEventListener('load', fetchTransactions);
</script>

</body>
</html>
