<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard | Rivava Finance</title>

<!-- App Icons (uses your folder: icons_folder) -->
<link rel="icon" type="image/png" sizes="32x32" href="./icons_folder/icon-32x32.png">
<link rel="apple-touch-icon" href="./icons_folder/icon-180x180.png">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg-dark:#000;
    --card-dark:#0d0d0d;
    --accent:#00ffc3;
    --text:#fff;
    --muted:#888;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background:var(--bg-dark);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
  }
  
  /* Header */
  .history-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background-color: var(--card-dark);
      border-bottom: 1px solid #1a1a1a;
      position: sticky;
      top: 0;
      z-index: 100;
  }
  .back-btn {
      background: none; border: none; color: var(--text);
      cursor: pointer; margin-right: 16px;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
  }
  .back-btn svg { width: 24px; height: 24px; }
  .history-header h2 { margin: 0; font-size: 1.2rem; }
  
  /* Main Content */
  .history-content { padding: 16px; max-width: 920px; margin: 0 auto; }
  
  .filter-pills {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
  }
  .filter-pills button {
      background: #222;
      border: 1px solid #333;
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 99px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
  }
  .filter-pills button.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
  }
  
  .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
  }
  .summary-card {
      background: var(--card-dark);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #1a1a1a;
  }
  .summary-card .title {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 8px;
  }
  .summary-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
  }

  .chart-container {
      background: var(--card-dark);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #1a1a1a;
  }
  #historyLoader, #noHistoryMessage { text-align: center; padding: 40px; color: var(--muted); font-size: 1.1rem; }
</style>
</head>
<body>

<header class="history-header">
    <button class="back-btn" onclick="goBack()" aria-label="Go Back">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
    </button>
    <h2>Dashboard</h2>
</header>
<div class="history-content">
    <div class="filter-pills" id="filterPills">
        <button class="active" data-filter="today">Today</button>
        <button data-filter="week">This Week</button>
        <button data-filter="month">This Month</button>
        <button data-filter="all">All Time</button>
    </div>
    <div class="summary-cards">
        <div class="summary-card">
            <div class="title" id="spentTitle">Spent Today</div>
            <div class="value" id="totalSpent">₹0.00</div>
        </div>
        <div class="summary-card">
            <div class="title" id="earnedTitle">Earned Today</div>
            <div class="value" id="totalEarned">₹0.00</div>
        </div>
    </div>
    <div class="chart-container">
        <canvas id="expenseChart"></canvas>
    </div>
    <div id="historyLoader">Loading your dashboard...</div>
    <div id="noHistoryMessage" style="display: none;">You have no transactions for this period.</div>
</div>

<script>
let allTransactions = [];
let expenseChart = null;

const firebaseConfig = { apiKey: "AIzaSyAEB3DSSIWATjfcbmkO094GsO56paxrDhU", authDomain: "rivava-finance-tracker.firebaseapp.com", projectId: "rivava-finance-tracker", storageBucket: "rivava-finance-tracker.appspot.com", messagingSenderId: "615077199032", appId: "1:615077199032:web:fb2007f8a603fa8abcc84d" };
let db;
try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch (error) { console.error("Firebase Init Error:", error); }

function goBack() {
    window.location.href = './index.html';
}

async function fetchTransactions() {
    const loader = document.getElementById('historyLoader');
    const noHistoryMessage = document.getElementById('noHistoryMessage');
    
    loader.style.display = 'block';
    noHistoryMessage.style.display = 'none';

    const user = JSON.parse(localStorage.getItem('rivava_user'));
    if (!user || !user.email) {
        loader.style.display = 'none';
        noHistoryMessage.textContent = 'Please sign in to view your history.';
        noHistoryMessage.style.display = 'block';
        setTimeout(() => { goBack(); }, 2000);
        return;
    }

    try {
        const querySnapshot = await db.collection("submissions").where("userEmail", "==", user.email).get();
        let transactions = [];
        querySnapshot.forEach(doc => {
            transactions = transactions.concat(doc.data().transactions);
        });

        allTransactions = transactions.map(t => {
            const [day, month, year] = t.date.split('/');
            const timeStr = t.time.replace(/(\d{2}:\d{2}:\d{2}) (AM|PM)/, (match, time, period) => {
                let [h, m, s] = time.split(':');
                if (period === 'PM' && h !== '12') h = +h + 12;
                if (period === 'AM' && h === '12') h = '00';
                return `${h}:${m}:${s}`;
            });
            t.jsDate = new Date(`${year}-${month}-${day}T${timeStr}`);
            return t;
        });
        
        updateDashboard('today');

    } catch (error) {
        console.error("Error fetching history:", error);
        noHistoryMessage.textContent = 'Could not load your history.';
        noHistoryMessage.style.display = 'block';
    } finally {
        loader.style.display = 'none';
    }
}

function updateDashboard(filter) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let startDate;

    switch(filter) {
        case 'week':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay());
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        case 'all':
            startDate = new Date(0); // The beginning of time
            break;
        case 'today':
        default:
            startDate = today;
            break;
    }

    const filteredTransactions = allTransactions.filter(t => t.jsDate >= startDate);

    // Update Summary Cards
    let totalSpent = 0;
    let totalEarned = 0;
    filteredTransactions.forEach(t => {
        if (t.type === 'Expense') totalSpent += t.amount;
        if (t.type === 'Earning') totalEarned += t.amount;
    });
    
    const periodText = filter.charAt(0).toUpperCase() + filter.slice(1);
    document.getElementById('spentTitle').textContent = `Spent ${periodText}`;
    document.getElementById('earnedTitle').textContent = `Earned ${periodText}`;
    document.getElementById('totalSpent').textContent = `₹${totalSpent.toFixed(2)}`;
    document.getElementById('totalEarned').textContent = `₹${totalEarned.toFixed(2)}`;

    // Update Chart
    const expenseData = filteredTransactions
        .filter(t => t.type === 'Expense')
        .reduce((acc, t) => {
            acc[t.category] = (acc[t.category] || 0) + t.amount;
            return acc;
        }, {});

    const chartLabels = Object.keys(expenseData);
    const chartValues = Object.values(expenseData);

    document.getElementById('noHistoryMessage').style.display = filteredTransactions.length === 0 ? 'block' : 'none';
    
    renderChart(chartLabels, chartValues);
}

function renderChart(labels, data) {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    if (expenseChart) {
        expenseChart.destroy();
    }
    
    if(labels.length === 0) {
        return; // Don't render an empty chart
    }

    expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: 'Expenses',
                data: data,
                backgroundColor: [
                    '#00ffc3', '#ff6b6b', '#4d94ff', '#feca57', 
                    '#ff9ff3', '#54a0ff', '#5f27cd', '#c8d6e5'
                ],
                borderColor: '#0d0d0d',
                borderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#fff',
                        font: {
                            family: "'Poppins', sans-serif",
                            size: 14
                        }
                    }
                }
            }
        }
    });
}

document.getElementById('filterPills').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
        document.querySelectorAll('#filterPills button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        updateDashboard(e.target.dataset.filter);
    }
});

window.addEventListener('load', fetchTransactions);
</script>

</body>
</html>
