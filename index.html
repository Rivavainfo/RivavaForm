<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rivava Finance Tracker</title>

<!-- Favicon and App Icons -->
<link rel="icon" type="image/png" href="logo.png">
<link rel="apple-touch-icon" href="logo.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<!-- Fonts & Google Identity lib -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<!-- Load Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Load Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg-dark:#000;
    --card-dark:#0d0d0d;
    --accent:#00ffc3;
    --accent-2:#00d9aa;
    --text:#fff;
    --muted:#888;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background:var(--bg-dark);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    overflow-x: hidden;
  }

  /* Header */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:16px 20px;
    background:var(--card-dark);
    border-bottom:1px solid #111;
    position:sticky;
    top:0;
    z-index:100;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transform: translateZ(0);
    will-change: auto;
  }
  .brand {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .logo-img { /* Changed from .logo to style the image */
    width:40px;
    height:40px;
    border-radius:8px;
    object-fit:cover;
    box-shadow:0 4px 14px rgba(0,0,0,0.4);
  }
  .username {
    font-size:1.25rem;
    font-weight:700;
    background:linear-gradient(90deg,var(--accent),#fff);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
  }

  /* signin area - styled like a card */
  .signin-card{
    max-width:920px;margin:28px auto;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;border:1px solid #111;display:flex;align-items:center;gap:18px;
    box-shadow:0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
  }
  .signin-left{flex:1;min-width:0}
  .signin-right{width:220px;display:flex;flex-direction:column;align-items:center;gap:12px}
  .signin-title{font-size:1.1rem;font-weight:700;margin-bottom:6px;letter-spacing: 0.3px}
  .signin-sub{color:var(--muted);font-size:0.95rem;margin-bottom:12px;line-height:1.4}

  /* Google Sign-In button styling */
  #g_id_signin_container {
    width: 100%;
    margin-bottom: 4px;
  }
  .g_id_signin {
    width: 100% !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    overflow: hidden;
  }
  .g_id_signin iframe {
    border-radius: 10px !important;
  }

  /* user display */
  .user-chip{
    display:flex;
    gap:10px;
    align-items:center;
    background:#0b0b0b;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid #111;
  }
  .avatar{
    width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0;
  }
  .user-info {
    text-align: left;
  }
  .user-name{
    font-weight:700;
    font-size:0.95rem;
  }
  .user-email {
    color:var(--muted);
    font-size:0.8rem;
  }

  /* main form area */
  main{
    max-width:920px;
    margin:18px auto;
    padding:18px;
  }
  .info-blocks{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
    margin-bottom:18px;
  }
  .info-block{
    background:var(--card-dark);
    padding:14px;
    border-radius:12px;
    text-align:center;
    border:1px solid #111;
    transition: opacity 0.4s ease, transform 0.4s ease; /* Added for fade animation */
  }
  /* NEW: Class for fading out the time block */
  .info-block.fade-out {
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
  }
  .info-block .value{
    display:block;
    margin-top:8px;
    font-size:1.6rem;
    color:var(--accent);
    font-weight:600;
  }
  .tabs{
    display:flex;
    gap:10px;
    margin-bottom:16px;
  }
  .tab{
    flex:1;
    background:var(--card-dark);
    padding:12px;
    border-radius:10px;
    text-align:center;
    cursor:pointer;
    border:1px solid #111;
    transition:all 0.2s ease;
  }
  .tab:hover{
    background:#111;
  }
  .tab.active{
    background:var(--accent);
    color:#000;
    font-weight:700;
  }
  .form-section{
    display:none;
    background:var(--card-dark);
    padding:18px;
    border-radius:12px;
    border:1px solid #111;
  }
  .form-section.active{
    display:block;
  }
  label{
    display:block;
    margin-bottom:6px;
    font-weight:600;
    font-size:0.9rem;
  }
  input,select{
    width:100%;
    padding:12px;
    border-radius:8px;
    background:#111;
    border:1px solid #222;
    color:var(--text);
    margin-bottom:12px;
    font-size:16px;
  }
  input:focus,select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(0,255,195,0.2);
  }
  button.primary{
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    border:none;
    padding:12px 20px;
    border-radius:8px;
    color:#000;
    font-weight:700;
    cursor:pointer;
    width:100%;
    margin-top:8px;
    font-size:1rem;
    transition: all 0.2s ease;
  }
  button.primary:hover{
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 195, 0.3);
  }

  /* Table styling with horizontal scrolling */
  .table-container{
    overflow-x:auto;
    margin-top:16px;
    border-radius:12px;
    overflow:hidden;
    -webkit-overflow-scrolling: touch;
  }
  table{
    width:100%;
    border-collapse:collapse;
    min-width:800px; /* Ensures horizontal scroll on small screens */
  }
  th,td{
    padding:12px 8px;
    border-bottom:1px solid #222;
    text-align:left;
    white-space: nowrap;
  }
  th{
    color:var(--accent);
    font-weight:700;
    font-size:0.9rem;
    background: rgba(255,255,255,0.02);
  }
  td{
    font-size:0.85rem;
  }
  td button{
    background:#ff4757;
    color:#fff;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    font-size:0.8rem;
    transition: all 0.2s ease;
    min-width: 60px;
  }
  td button:hover{
    background:#ff3838;
  }

  /* welcome overlay */
  #welcomeOverlay{
    position:fixed;
    left:50%;
    top:20%;
    transform:translateX(-50%) translateY(-10px);
    padding:14px 20px;
    border-radius:12px;
    background:linear-gradient(90deg,#18c29a,#00ffc3);
    color:#012;
    display:flex;
    align-items:center;
    gap:12px;
    box-shadow:0 12px 30px rgba(0,0,0,0.6);
    opacity:0;
    pointer-events:none;
    z-index:9999;
    transition:opacity .4s ease, transform .4s ease;
    border: 1px solid rgba(255,255,255,0.1);
  }
  #welcomeOverlay.show{
    opacity:1;
    transform:translateX(-50%) translateY(0);
    pointer-events:auto;
  }

  /* Sign out button styling */
  .signout-btn {
    background: linear-gradient(90deg, #ff6b6b, #ff5252) !important;
    color: white !important;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    min-width: 100px;
  }
  .signout-btn:hover {
    background: linear-gradient(90deg, #ff5252, #ff4444) !important;
    transform: translateY(-1px);
  }

  /* NEW: Professional Success Modal Styles */
  .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
  }
  .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
  }
  .modal-content {
      background: var(--card-dark);
      padding: 30px;
      border-radius: 16px;
      border: 1px solid #222;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
      text-align: center;
      width: 90%;
      max-width: 380px;
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }
  .modal-overlay.show .modal-content {
      transform: scale(1);
  }
  .modal-logo {
      width: 70px;
      height: 70px;
      margin: 0 auto 15px;
      border-radius: 12px;
      animation: logo-pop 0.5s 0.2s ease-out backwards;
  }
  @keyframes logo-pop {
      0% { transform: scale(0.5) rotate(-15deg); opacity: 0; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }
  .modal-content h2 {
      margin: 0 0 10px;
      font-size: 1.8rem;
      color: var(--accent);
      font-weight: 700;
  }
  .modal-content p {
      margin: 0 0 25px;
      color: var(--muted);
      font-size: 1rem;
  }
  .modal-content button {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
  }
  .modal-content button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 195, 0.3);
  }


  /* Mobile responsive styles */
  @media(max-width:768px){
    header { padding: 12px 16px; }
    .brand { gap: 10px; }
    .logo-img { width: 36px; height: 36px; }
    .username { font-size: 1.15rem; }
    #topUserArea { margin-right: 0; }
    .user-chip { padding: 6px 10px; gap: 8px; }
    .avatar { width: 32px; height: 32px; }
    .user-name { font-size: 0.85rem; }

    .signin-card{
      flex-direction:column;
      align-items:stretch;
      margin:16px;
      padding:16px;
    }
    .signin-right{
      width:100%;
      flex-direction:row;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }

    main{
      margin:12px;
      padding:12px;
    }

    .info-blocks{
      grid-template-columns:1fr;
      gap:12px;
    }

    .tabs{
      flex-direction:column;
      gap:8px;
    }
    .tab{
      padding:14px;
      font-size:1rem;
    }

    .form-section{
      padding:16px;
    }

    input,select{
      padding:14px;
      font-size:16px;
    }

    button.primary{
      padding:14px;
      font-size:1.1rem;
    }

    th,td{
      padding:10px 6px;
      font-size:0.8rem;
    }

    .signin-title{
      font-size:1.2rem;
      text-align:center;
    }

    .signin-sub{
      text-align:center;
      font-size:0.9rem;
    }

    #welcomeOverlay{
      left:10px;
      right:10px;
      transform:translateX(0) translateY(-10px);
      max-width:calc(100% - 20px);
    }
    #welcomeOverlay.show{
      transform:translateX(0) translateY(0);
    }
  }

  @media(max-width:480px){
    header { padding: 10px 12px; }
    .brand { gap: 8px; }
    .logo-img { width: 32px; height: 32px; }
    .username { font-size: 1.05rem; }
    .user-chip { padding: 5px 8px; gap: 6px; }
    .avatar { width: 28px; height: 28px; }
    .user-name { font-size: 0.8rem; }
    .user-email { display: none; }

    .signin-card{
      margin:12px;
      padding:12px;
    }

    .signin-right{
      flex-direction:column;
      align-items:stretch;
    }

    main{
      margin:8px;
      padding:8px;
    }

    .info-block .value{
      font-size:1.4rem;
    }

    table{
      min-width:700px;
    }

    #welcomeOverlay{
      padding:12px 16px;
      font-size:0.9rem;
    }

    .signout-btn{
      width:100%;
      margin-top:8px;
    }

    .user-info {
      max-width: 150px;
      overflow: hidden;
    }
    .user-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Mobile table optimization */
    table {
      font-size: 0.75rem;
    }
    th, td {
      padding: 8px 4px;
    }
    th {
      font-size: 0.7rem;
    }
    td {
      font-size: 0.7rem;
    }

    /* Ensure action button is visible */
    td button {
      min-width: 50px;
      padding: 4px 8px;
      font-size: 0.7rem;
    }
  }

  /* Dark scrollbar */
  ::-webkit-scrollbar{width:8px;height:8px}
  ::-webkit-scrollbar-track{background:#111}
  ::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
  ::-webkit-scrollbar-thumb:hover{background:#444}
</style>
</head>
<body>

<header>
  <div class="brand">
    <!-- MODIFIED: Replaced div with img tag for the logo -->
    <img src="logo.png" alt="Rivava Logo" class="logo-img">
    <div class="username">RIVAVA</div>
  </div>

  <!-- top-right: user area (shows signin button or user) -->
  <div id="topUserArea" style="margin-right:14px;">
    <!-- will be filled by JS -->
  </div>
</header>

<!-- Sign-in card (designer style) -->
<section class="signin-card" id="signinCard">
  <div class="signin-left">
    <div class="signin-title">Welcome to Rivava Finance</div>
    <div class="signin-sub">Track earnings & expenses quickly — secure sign in required to save your data privately.</div>

    <div id="signedInInfo" style="display:none;">
      <div class="user-chip">
        <img id="profilePic" class="avatar" src="" alt="avatar">
        <div class="user-info">
          <div class="user-name" id="displayName"></div>
          <div class="user-email" id="displayEmail"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="signin-right">
    <div id="g_id_signin_container"></div>
    <button id="signoutBtn" class="signout-btn" style="display:none;" onclick="signOut()">Sign out</button>
  </div>
</section>

<!-- form -->
<main>
  <!-- MODIFIED: Rearranged info blocks -->
  <div class="info-blocks">
    <div class="info-block" id="timeBlock">
      Time
      <span class="value" id="liveTime">--:--:-- --</span>
    </div>
    <div class="info-block" id="dateBlock">
      Date
      <span class="value" id="fixedDate">--/--/----</span>
    </div>
    <div class="info-block" id="totalExpenseBlock">
      Total Expense
      <span class="value" id="totalExpense">₹0</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('earning')">Earning</div>
    <div class="tab" onclick="showTab('expense')">Expense</div>
  </div>

  <!-- MODIFIED: Added categories to Earning tab -->
  <div id="earning" class="form-section active">
    <label>Category</label>
    <select id="earningCategory" onchange="handleEarningCategoryChange()">
      <option>Salary</option>
      <option>Daily Earning</option>
      <option>Other</option>
    </select>
    <input type="text" id="customEarningCategory" placeholder="Enter custom earning source" style="display:none;margin-top:8px;padding:12px;border-radius:8px;border:1px solid #222;background:#111;color:var(--text);font-size:16px;" />
    
    <label>Amount</label>
    <input type="number" id="earningAmount" placeholder="Enter earning amount" min="0" step="0.01" />
    <button class="primary" onclick="addEarning()">Add Earning</button>
  </div>

  <div id="expense" class="form-section">
    <label>Category</label>
    <select id="expenseCategory" onchange="handleCategoryChange()">
      <option>Personal</option>
      <option>Food</option>
      <option>Transport</option>
      <option>Shopping</option>
      <option>Recharge and Bills</option>
      <option>Entertainment</option>
      <option>Other</option>
    </select>

    <input type="text" id="customCategory" placeholder="Enter data" style="display:none;margin-top:8px;padding:12px;border-radius:8px;border:1px solid #222;background:#111;color:var(--text);font-size:16px;" />

    <label>Amount</label>
    <input type="number" id="expenseAmount" placeholder="Enter expense amount" min="0" step="0.01" />

    <label>Payment Method</label>
    <select id="paymentMethod">
      <option>UPI</option>
      <option>Cash</option>
      <option>Credit Card</option>
      <option>Bank Transfer</option>
    </select>

    <button class="primary" onclick="addExpense()">Add Expense</button>
  </div>

  <div class="table-container">
    <table id="dataTable" aria-label="Transactions table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Payment</th>
          <th>Date</th>
          <th>Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button id="submitBtn" class="primary" onclick="submitForm()">Submit</button>

</main>

<!-- Welcome overlay -->
<div id="welcomeOverlay" role="status" aria-live="polite">
  <img id="welcomeAvatar" src="" alt="" style="width:48px;height:48px;border-radius:50%;object-fit:cover">
  <div id="welcomeText" style="font-weight:800;color:#012"></div>
</div>

<!-- NEW: Professional Success Modal -->
<div id="successModal" class="modal-overlay">
    <div class="modal-content">
        <img src="logo.png" alt="Success" class="modal-logo">
        <h2>Success!</h2>
        <p>Your transactions have been saved securely.</p>
        <button onclick="closeSuccessModal()">Done</button>
    </div>
</div>

<script>
/* ----------------------
  CONFIG: Firebase Configuration
  ---------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAEB3DSSIWATjfcbmkO094GsO56paxrDhU",
  authDomain: "rivava-finance-tracker.firebaseapp.com",
  projectId: "rivava-finance-tracker",
  storageBucket: "rivava-finance-tracker.firebasestorage.app",
  messagingSenderId: "615077199032",
  appId: "1:615077199032:web:fb2007f8a603fa8abcc84d",
  measurementId: "G-NF4BZPWR2E"
};

// Initialize Firebase
let db;
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase initialized successfully.");
  } else {
    console.log("Firebase app already initialized.");
  }
  db = firebase.firestore();
  console.log("Firestore instance ready.");
} catch (error) {
  console.error("Error initializing Firebase:", error);
  // Using a custom modal for alerts would be better, but sticking to existing patterns
  // alert("Failed to initialize Firebase. Please check the console for details.");
}

/* ----------------------
  CLIENT ID
  ---------------------- */
const GOOGLE_CLIENT_ID = "151251461452-qooai71ob9njlduadhpqr55kuf5hfb40.apps.googleusercontent.com";


/* ----------------------
  helpers
  ---------------------- */
function parseJwt(token){
  try{
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c=>'%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload);
  }catch(e){
    return null;
  }
}

/* ----------------------
  welcome overlay
  ---------------------- */
function showWelcome(name, picture){
  const ov = document.getElementById('welcomeOverlay');
  const txt = document.getElementById('welcomeText');
  const av = document.getElementById('welcomeAvatar');
  txt.textContent = `Welcome, ${name}`;
  av.src = picture || '';
  ov.classList.add('show');
  setTimeout(()=> ov.classList.remove('show'), 2000);
}

/* ----------------------
  Update UI for signed-in user
  ---------------------- */
function setSignedInUI(userObj, showWelcomeFlag){
  const top = document.getElementById('topUserArea');
  top.innerHTML = ''; // clear
  const firstName = userObj.name.split(' ')[0];

  const chip = document.createElement('div');
  chip.className = 'user-chip';
  chip.innerHTML = `
    <img src="${userObj.picture}" class="avatar" alt="Profile">
    <div class="user-info">
      <div class="user-name">${firstName}</div>
      <div class="user-email">${userObj.email}</div>
    </div>
  `;
  top.appendChild(chip);

  document.getElementById('signedInInfo').style.display = 'block';
  document.getElementById('profilePic').src = userObj.picture || '';
  document.getElementById('displayName').textContent = firstName || '';
  document.getElementById('displayEmail').textContent = userObj.email || '';
  document.getElementById('signoutBtn').style.display = 'inline-block';
  document.getElementById('g_id_signin_container').innerHTML = '';

  if(showWelcomeFlag) showWelcome(firstName, userObj.picture);
}

/* ----------------------
  Sign out function
  ---------------------- */
function signOut(){
  localStorage.removeItem('rivava_user');
  document.getElementById('signedInInfo').style.display = 'none';
  document.getElementById('signoutBtn').style.display = 'none';
  document.getElementById('topUserArea').innerHTML = '';

  if(window.google && google.accounts && google.accounts.id){
    google.accounts.id.disableAutoSelect();
  }

  setTimeout(() => {
    renderSignIn();
  }, 100);

  document.querySelector("#dataTable tbody").innerHTML = '';
  updateTotalExpense();
  console.log('User signed out successfully');
}

/* ----------------------
  Render Google Sign-in button (GSI)
  ---------------------- */
function renderSignIn(){
  const container = document.getElementById('g_id_signin_container');
  container.innerHTML = '';

  if(window.google && google.accounts && google.accounts.id){
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleCredentialResponse,
      auto_select: false,
      ux_mode: 'popup'
    });
    google.accounts.id.renderButton(
      container,
      {
        theme: 'outline', size: 'large', type: 'standard',
        text: 'signin_with', shape: 'rounded', logo_alignment: 'left'
      }
    );
  } else {
    setTimeout(renderSignIn, 300);
  }
}

/* ----------------------
  Callback after sign-in
  ---------------------- */
function handleCredentialResponse(response){
  const payload = parseJwt(response.credential);
  if(!payload || !payload.email){
    console.error('Invalid ID token payload', payload);
    return;
  }
  const user = {
    name: payload.name,
    email: payload.email,
    picture: payload.picture,
    token: response.credential,
    sub: payload.sub
  };
  localStorage.setItem('rivava_user', JSON.stringify(user));
  setSignedInUI(user, true);
}

/* ----------------------
  On load: check stored user or initialize sign-in
  ---------------------- */
window.addEventListener('load', ()=> {
  setFixedDate();
  startLiveTime();

  const s = localStorage.getItem('rivava_user');
  if(s){
    try{
      const user = JSON.parse(s);
      setSignedInUI(user, true);
    }catch(e){
      console.warn('restore user failed',e);
      localStorage.removeItem('rivava_user');
      renderSignIn();
    }
  } else {
    renderSignIn();
  }
});

/* ----------------------
  NEW: Scroll handling for time block fade animation
  ---------------------- */
const timeBlock = document.getElementById('timeBlock');
window.addEventListener('scroll', () => {
    if (window.scrollY > 50) { // Fades out after scrolling 50px
        timeBlock.classList.add('fade-out');
    } else {
        timeBlock.classList.remove('fade-out');
    }
}, { passive: true });


/* ----------------------
  Form JS
  ---------------------- */
function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
  document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(tab).classList.add('active');
}

function setFixedDate() {
  const today = new Date();
  const day = String(today.getDate()).padStart(2, "0");
  const month = String(today.getMonth() + 1).padStart(2, "0");
  const year = today.getFullYear();
  const formatted = `${day}/${month}/${year}`;
  document.getElementById("fixedDate").textContent = formatted;
  return formatted;
}

// MODIFIED: Clock format changed to 12-hour
function startLiveTime() {
  const timeEl = document.getElementById("liveTime");
  function update() {
    const now = new Date();
    let h = now.getHours();
    const m = now.getMinutes().toString().padStart(2, "0");
    const s = now.getSeconds().toString().padStart(2, "0");
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12;
    h = h ? h : 12; // the hour '0' should be '12'
    const hStr = h.toString().padStart(2, "0");
    timeEl.textContent = `${hStr}:${m}:${s} ${ampm}`;
  }
  update();
  setInterval(update, 1000);
}

const dataTableBody = document.querySelector("#dataTable tbody");
let totalExpense = 0;

function updateTotalExpense() {
  let sum = 0;
  dataTableBody.querySelectorAll("tr").forEach(row => {
    const type = row.cells[0].textContent;
    if (type === "Expense") {
      const amt = parseFloat(row.cells[1].textContent);
      if (!isNaN(amt)) sum += amt;
    }
  });
  totalExpense = sum;
  document.getElementById("totalExpense").textContent = `₹${totalExpense.toFixed(2)}`;
}

function addRow(type, amount, category, payment, date, time) {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${type}</td>
    <td>${parseFloat(amount).toFixed(2)}</td>
    <td>${category}</td>
    <td>${payment}</td>
    <td>${date}</td>
    <td>${time}</td>
    <td><button onclick="deleteRow(this)" aria-label="Delete this ${type.toLowerCase()} entry">Delete</button></td>
  `;
  dataTableBody.appendChild(row);
  updateTotalExpense();
}

function deleteRow(button) {
  button.closest("tr").remove();
  updateTotalExpense();
}

// MODIFIED: Added handler for Earning category
function handleEarningCategoryChange() {
    const categorySelect = document.getElementById("earningCategory");
    const customInput = document.getElementById("customEarningCategory");
    if (categorySelect.value === "Other") {
        customInput.style.display = "block";
        customInput.focus();
    } else {
        customInput.style.display = "none";
        customInput.value = "";
    }
}

function handleCategoryChange() {
  const categorySelect = document.getElementById("expenseCategory");
  const customInput = document.getElementById("customCategory");
  if (categorySelect.value === "Other") {
    customInput.style.display = "block";
    customInput.focus();
  } else {
    customInput.style.display = "none";
    customInput.value = "";
  }
}

// MODIFIED: addEarning now includes category
function addEarning() {
  const amountInput = document.getElementById("earningAmount");
  const amount = amountInput.value.trim();
  if (!amount || Number(amount) <= 0) {
    // alert("Please enter a valid earning amount.");
    return;
  }
  
  const categorySelect = document.getElementById("earningCategory");
  let category = categorySelect.value;
  if (category === "Other") {
      const customCat = document.getElementById("customEarningCategory").value.trim();
      if (!customCat) {
          // alert("Please enter a custom earning source.");
          return;
      }
      category = customCat;
  }

  const date = document.getElementById("fixedDate").textContent;
  const time = document.getElementById("liveTime").textContent;
  addRow("Earning", amount, category, "-", date, time); // Payment is '-' for earning
  
  amountInput.value = "";
  if (categorySelect.value === "Other") {
      document.getElementById("customEarningCategory").value = "";
      document.getElementById("customEarningCategory").style.display = "none";
      categorySelect.value = "Salary";
  }
}

function addExpense() {
  const amountInput = document.getElementById("expenseAmount");
  const amount = amountInput.value.trim();
  if (!amount || Number(amount) <= 0) {
    // alert("Please enter a valid expense amount.");
    return;
  }

  const categorySelect = document.getElementById("expenseCategory");
  let category = categorySelect.value;

  if (category === "Other") {
    const customCat = document.getElementById("customCategory").value.trim();
    if (!customCat) {
      // alert("Please enter a custom category.");
      return;
    }
    category = customCat;
  }

  const payment = document.getElementById("paymentMethod").value;
  const date = document.getElementById("fixedDate").textContent;
  const time = document.getElementById("liveTime").textContent;
  addRow("Expense", amount, category, payment, date, time);
  amountInput.value = "";

  if (categorySelect.value === "Other") {
    document.getElementById("customCategory").value = "";
    document.getElementById("customCategory").style.display = "none";
    categorySelect.value = "Personal";
  }
}

// MODIFIED: submitForm to use the new professional modal
async function submitForm() {
  if (dataTableBody.children.length === 0) {
    // alert("Please add some earnings or expenses before submitting.");
    return;
  }

  const stored = localStorage.getItem('rivava_user');
  if (!stored) {
    // alert("You must sign in first.");
    return;
  }

  const user = JSON.parse(stored);

  const rows = [];
  dataTableBody.querySelectorAll('tr').forEach(r => {
    rows.push({
      type: r.cells[0].textContent.trim(),
      amount: parseFloat(r.cells[1].textContent.trim()),
      category: r.cells[2].textContent.trim(),
      payment: r.cells[3].textContent.trim(),
      date: r.cells[4].textContent.trim(),
      time: r.cells[5].textContent.trim()
    });
  });

  const payload = {
    userEmail: user.email,
    userName: user.name,
    transactions: rows,
    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    const docRef = await db.collection('submissions').add(payload);
    console.log("Data successfully written to Firebase with ID: ", docRef.id);

    // Show the new success modal
    showSuccessModal();

    // Optional: Clear the form table after successful submission
    // dataTableBody.innerHTML = '';
    // updateTotalExpense();

  } catch (error) {
    console.error("Error submitting data to Firebase:", error);
    // alert("❌ Failed to save data. Please check the console. Error: " + error.message);
  }
}

// NEW: Functions to control the success modal
function showSuccessModal() {
    const modal = document.getElementById('successModal');
    if (modal) {
        modal.classList.add('show');
    }
}

function closeSuccessModal() {
    const modal = document.getElementById('successModal');
    if (modal) {
        modal.classList.remove('show');
    }
}


// Add touch events for better mobile experience
document.addEventListener('touchstart', function() {}, {passive: true});
</script>

</body>
</html>
