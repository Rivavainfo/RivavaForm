html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rivava Finance Tracker</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Rivava">
<link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlJpdmF2YSBGaW5hbmNlIFRyYWNrZXIiLAogICJzaG9ydF9uYW1lIjogIlJpdmF2YSIsCiAgImRlc2NyaXB0aW9uIjogIlRyYWNrIGVhcm5pbmdzICYgZXhwZW5zZXMgcXVpY2tseSB3aXRoIHNlY3VyZSBHb29nbGUgc2lnbi1pbiIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDAwMDAwIiwKICAidGhlbWVfY29sb3IiOiAiIzAwMDAwMCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQzBBQUFBdENBUUFBQUFqNlJHMElKU0FBQUFBRWxGVGtFdlZsQlBTa1ZPSFE9IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

<!-- Fonts & Google Identity lib -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<!-- Load Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Load Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg-dark:#000;
    --card-dark:#0d0d0d;
    --accent:#00ffc3;
    --accent-2:#00d9aa;
    --text:#fff;
    --muted:#888;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background:var(--bg-dark);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    overflow-x: hidden;
  }

  /* Header */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:16px 20px;
    background:var(--card-dark);
    border-bottom:1px solid #111;
    position:sticky;
    top:0;
    z-index:100;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transform: translateZ(0);
    will-change: auto;
    transition: all 0.3s ease;
  }
  header.hidden {
    transform: translateY(-100%);
  }
  .brand {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .logo {
    width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7bf7d0);box-shadow:0 4px 14px rgba(0,0,0,0.4);
    display:flex;align-items:center;justify-content:center;color:#000;font-weight:700;
  }
  .username {
    font-size:1.25rem;
    font-weight:700;
    background:linear-gradient(90deg,var(--accent),#fff);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
  }

  /* Mobile header improvements */
  @media(max-width:768px) {
    header {
      padding: 12px 16px;
    }
    .brand {
      gap: 10px;
    }
    .logo {
      width: 36px;
      height: 36px;
    }
    .username {
      font-size: 1.15rem;
    }
    #topUserArea {
      margin-right: 0;
    }
    .user-chip {
      padding: 6px 10px;
      gap: 8px;
    }
    .avatar {
      width: 32px;
      height: 32px;
    }
    .user-name {
      font-size: 0.85rem;
    }
  }

  @media(max-width:480px) {
    header {
      padding: 10px 12px;
    }
    .brand {
      gap: 8px;
    }
    .logo {
      width: 32px;
      height: 32px;
    }
    .username {
      font-size: 1.05rem;
    }
    .user-chip {
      padding: 5px 8px;
      gap: 6px;
    }
    .avatar {
      width: 28px;
      height: 28px;
    }
    .user-name {
      font-size: 0.8rem;
    }
    .user-email {
      display: none;
    }
  }

  /* signin area - styled like a card */
  .signin-card{
    max-width:920px;margin:28px auto;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;border:1px solid #111;display:flex;align-items:center;gap:18px;
    box-shadow:0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
  }
  .signin-left{flex:1;min-width:0}
  .signin-right{width:220px;display:flex;flex-direction:column;align-items:center;gap:12px}
  .signin-title{font-size:1.1rem;font-weight:700;margin-bottom:6px;letter-spacing: 0.3px}
  .signin-sub{color:var(--muted);font-size:0.95rem;margin-bottom:12px;line-height:1.4}

  /* Google Sign-In button styling */
  #g_id_signin_container {
    width: 100%;
    margin-bottom: 4px;
  }
  .g_id_signin {
    width: 100% !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    overflow: hidden;
  }
  .g_id_signin iframe {
    border-radius: 10px !important;
  }

  /* user display */
  .user-chip{
    display:flex;
    gap:10px;
    align-items:center;
    background:#0b0b0b;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid #111;
  }
  .avatar{
    width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0;
  }
  .user-info {
    text-align: left;
  }
  .user-name{
    font-weight:700;
    font-size:0.95rem;
  }
  .user-email {
    color:var(--muted);
    font-size:0.8rem;
  }

  /* main form area */
  main{
    max-width:920px;
    margin:18px auto;
    padding:18px;
  }
  .info-blocks{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
    margin-bottom:18px;
    transition: opacity 0.3s ease;
  }
  .info-blocks.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .info-block{
    background:var(--card-dark);
    padding:14px;
    border-radius:12px;
    text-align:center;
    border:1px solid #111;
  }
  .info-block .value{
    display:block;
    margin-top:8px;
    font-size:1.6rem;
    color:var(--accent);
    font-weight:600;
  }
  .tabs{
    display:flex;
    gap:10px;
    margin-bottom:16px;
    transition: opacity 0.3s ease;
  }
  .tabs.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .tab{
    flex:1;
    background:var(--card-dark);
    padding:12px;
    border-radius:10px;
    text-align:center;
    cursor:pointer;
    border:1px solid #111;
    transition:all 0.2s ease;
  }
  .tab:hover{
    background:#111;
  }
  .tab.active{
    background:var(--accent);
    color:#000;
    font-weight:700;
  }
  .form-section{
    display:none;
    background:var(--card-dark);
    padding:18px;
    border-radius:12px;
    border:1px solid #111;
  }
  .form-section.active{
    display:block;
  }
  label{
    display:block;
    margin-bottom:6px;
    font-weight:600;
    font-size:0.9rem;
  }
  input,select{
    width:100%;
    padding:12px;
    border-radius:8px;
    background:#111;
    border:1px solid #222;
    color:var(--text);
    margin-bottom:12px;
    font-size:16px;
  }
  input:focus,select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(0,255,195,0.2);
  }
  button.primary{
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    border:none;
    padding:12px 20px;
    border-radius:8px;
    color:#000;
    font-weight:700;
    cursor:pointer;
    width:100%;
    margin-top:8px;
    font-size:1rem;
    transition: all 0.2s ease;
  }
  button.primary:hover{
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 195, 0.3);
  }

  /* Table styling with horizontal scrolling */
  .table-container{
    overflow-x:auto;
    margin-top:16px;
    border-radius:12px;
    overflow:hidden;
    -webkit-overflow-scrolling: touch;
  }
  table{
    width:100%;
    border-collapse:collapse;
    min-width:800px; /* Ensures horizontal scroll on small screens */
  }
  th,td{
    padding:12px 8px;
    border-bottom:1px solid #222;
    text-align:left;
    white-space: nowrap;
  }
  th{
    color:var(--accent);
    font-weight:700;
    font-size:0.9rem;
    background: rgba(255,255,255,0.02);
  }
  td{
    font-size:0.85rem;
  }
  td button{
    background:#ff4757;
    color:#fff;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    font-size:0.8rem;
    transition: all 0.2s ease;
    min-width: 60px;
  }
  td button:hover{
    background:#ff3838;
  }

  /* Enhanced confirmation message */
  .confirmation{
    display:none;
    background:linear-gradient(90deg, #18c29a, #00ffc3);
    color: #012;
    font-weight: 600;
    padding:14px;
    border-radius:12px;
    margin-top:16px;
    border:1px solid #222;
    text-align:center;
    animation: slideDown 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
    position: fixed;
    top: -100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    max-width: 90%;
    width: 400px;
  }
  @keyframes slideDown {
    from { top: -100px; }
    to { top: 20px; }
  }
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  .confirmation.error {
    background: linear-gradient(90deg, #ff6b6b, #ff5252);
    color: white;
  }

  /* welcome overlay */
  #welcomeOverlay{
    position:fixed;
    left:50%;
    top:20%;
    transform:translateX(-50%) translateY(-10px);
    padding:14px 20px;
    border-radius:12px;
    background:linear-gradient(90deg,#18c29a,#00ffc3);
    color:#012;
    display:flex;
    align-items:center;
    gap:12px;
    box-shadow:0 12px 30px rgba(0,0,0,0.6);
    opacity:0;
    pointer-events:none;
    z-index:9999;
    transition:opacity .4s ease, transform .4s ease;
    border: 1px solid rgba(255,255,255,0.1);
  }
  #welcomeOverlay.show{
    opacity:1;
    transform:translateX(-50%) translateY(0);
    pointer-events:auto;
  }

  /* Sign out button styling */
  .signout-btn {
    background: linear-gradient(90deg, #ff6b6b, #ff5252) !important;
    color: white !important;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    min-width: 100px;
  }
  .signout-btn:hover {
    background: linear-gradient(90deg, #ff5252, #ff4444) !important;
    transform: translateY(-1px);
  }

  /* Mobile responsive styles */
  @media(max-width:768px){
    .signin-card{
      flex-direction:column;
      align-items:stretch;
      margin:16px;
      padding:16px;
    }
    .signin-right{
      width:100%;
      flex-direction:row;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }

    main{
      margin:12px;
      padding:12px;
    }

    .info-blocks{
      grid-template-columns:1fr;
      gap:12px;
    }

    .tabs{
      flex-direction:column;
      gap:8px;
    }
    .tab{
      padding:14px;
      font-size:1rem;
    }

    .form-section{
      padding:16px;
    }

    input,select{
      padding:14px;
      font-size:16px;
    }

    button.primary{
      padding:14px;
      font-size:1.1rem;
    }

    th,td{
      padding:10px 6px;
      font-size:0.8rem;
    }

    .signin-title{
      font-size:1.2rem;
      text-align:center;
    }

    .signin-sub{
      text-align:center;
      font-size:0.9rem;
    }

    #welcomeOverlay{
      left:10px;
      right:10px;
      transform:translateX(0) translateY(-10px);
      max-width:calc(100% - 20px);
    }
    #welcomeOverlay.show{
      transform:translateX(0) translateY(0);
    }
    
    /* Always show delete button on mobile */
    td button {
      display: inline-block !important;
    }
  }

  @media(max-width:480px){
    .signin-card{
      margin:12px;
      padding:12px;
    }

    .signin-right{
      flex-direction:column;
      align-items:stretch;
    }

    main{
      margin:8px;
      padding:8px;
    }

    .info-block .value{
      font-size:1.4rem;
    }

    table{
      min-width:700px;
    }

    #welcomeOverlay{
      padding:12px 16px;
      font-size:0.9rem;
    }

    .signout-btn{
      width:100%;
      margin-top:8px;
    }

    .user-info {
      max-width: 150px;
      overflow: hidden;
    }
    .user-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Mobile table optimization */
    table {
      font-size: 0.75rem;
    }
    th, td {
      padding: 8px 4px;
    }
    th {
      font-size: 0.7rem;
    }
    td {
      font-size: 0.7rem;
    }

    /* Ensure action button is visible */
    td button {
      min-width: 50px;
      padding: 4px 8px;
      font-size: 0.7rem;
    }
  }

  /* Dark scrollbar */
  ::-webkit-scrollbar{width:8px;height:8px}
  ::-webkit-scrollbar-track{background:#111}
  ::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
  ::-webkit-scrollbar-thumb:hover{background:#444}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">R</div>
    <div class="username">RIVAVA</div>
  </div>

  <!-- top-right: user area (shows signin button or user) -->
  <div id="topUserArea" style="margin-right:14px;">
    <!-- will be filled by JS -->
  </div>
</header>

<!-- Sign-in card (designer style) -->
<section class="signin-card" id="signinCard">
  <div class="signin-left">
    <div class="signin-title">Welcome to Rivava Finance</div>
    <div class="signin-sub">Track earnings & expenses quickly — secure sign in required to save your data privately.</div>

    <div id="signedInInfo" style="display:none;">
      <div class="user-chip">
        <img id="profilePic" class="avatar" src="" alt="avatar">
        <div class="user-info">
          <div class="user-name" id="displayName"></div>
          <div class="user-email" id="displayEmail"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="signin-right">
    <div id="g_id_signin_container"></div>
    <button id="signoutBtn" class="signout-btn" style="display:none;" onclick="signOut()">Sign out</button>
  </div>
</section>

<!-- form (your original form UI preserved) -->
<main>
  <div class="info-blocks" id="infoBlocks">
    <div class="info-block" id="totalExpenseBlock">
      Total Expense
      <span class="value" id="totalExpense">₹0</span>
    </div>
    <div class="info-block" id="timeBlock">
      Time
      <span class="value" id="liveTime">--:--:--</span>
    </div>
    <div class="info-block" id="dateBlock">
      Date
      <span class="value" id="fixedDate">--/--/----</span>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" onclick="showTab('earning')">Earning</div>
    <div class="tab" onclick="showTab('expense')">Expense</div>
  </div>

  <div id="earning" class="form-section active">
    <label>Amount</label>
    <input type="number" id="earningAmount" placeholder="Enter earning amount" min="0" step="0.01" />
    <button class="primary" onclick="addEarning()">Add Earning</button>
  </div>

  <div id="expense" class="form-section">
    <label>Category</label>
    <select id="expenseCategory" onchange="handleCategoryChange()">
      <option>Personal</option>
      <option>Food</option>
      <option>Transport</option>
      <option>Shopping</option>
      <option>Recharge and Bills</option>
      <option>Entertainment</option>
      <option>Other</option>
    </select>

    <input type="text" id="customCategory" placeholder="Enter data" style="display:none;margin-top:8px;padding:12px;border-radius:8px;border:1px solid #222;background:#111;color:var(--text);font-size:16px;" />

    <label>Amount</label>
    <input type="number" id="expenseAmount" placeholder="Enter expense amount" min="0" step="0.01" />

    <label>Payment Method</label>
    <select id="paymentMethod">
      <option>UPI</option>
      <option>Cash</option>
      <option>Credit Card</option>
      <option>Bank Transfer</option>
    </select>

    <button class="primary" onclick="addExpense()">Add Expense</button>
  </div>

  <div class="table-container">
    <table id="dataTable" aria-label="Transactions table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Amount</th>
          <th>Category/Note</th>
          <th>Payment</th>
          <th>Date</th>
          <th>Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button id="submitBtn" class="primary" onclick="submitForm()">Submit</button>

  <div id="confirmationMessage" class="confirmation">✅ Thank you, your response has been submitted.</div>
</main>

<!-- Welcome overlay -->
<div id="welcomeOverlay" role="status" aria-live="polite">
  <img id="welcomeAvatar" src="" alt="" style="width:48px;height:48px;border-radius:50%;object-fit:cover">
  <div id="welcomeText" style="font-weight:800;color:#012"></div>
</div>

<script>
/* ----------------------
   PWA Service Worker Registration
   ---------------------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('application/javascript;base64,' + btoa(`
      const CACHE_NAME = 'rivava-finance-v1';
      const urlsToCache = ['/'];
      
      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
        );
      });
      
      self.addEventListener('fetch', event => {
        event.respondWith(
          caches.match(event.request)
            .then(response => response || fetch(event.request))
        );
      });
    `)).catch(function(err) {
      console.log('SW registration failed: ', err);
    });
  });
}

/* ----------------------
   CONFIG: Firebase Configuration (REPLACED APPS_SCRIPT_URL)
   ---------------------- */
// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAEB3DSSIWATjfcbmkO094GsO56paxrDhU",
  authDomain: "rivava-finance-tracker.firebaseapp.com",
  projectId: "rivava-finance-tracker",
  storageBucket: "rivava-finance-tracker.firebasestorage.app",
  messagingSenderId: "615077199032",
  appId: "1:615077199032:web:fb2007f8a603fa8abcc84d",
  measurementId: "G-NF4BZPWR2E"
};

// Initialize Firebase
let db; // Variable to hold the Firestore instance
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase initialized successfully.");
  } else {
    console.log("Firebase app already initialized.");
  }
  db = firebase.firestore(); // Get Firestore instance
  console.log("Firestore instance ready.");
} catch (error) {
  console.error("Error initializing Firebase:", error);
  alert("Failed to initialize Firebase. Please check the console for details.");
}

/* ----------------------
   CLIENT ID (already provided earlier)
   ---------------------- */
const GOOGLE_CLIENT_ID = "151251461452-qooai71ob9njlduadhpqr55kuf5hfb40.apps.googleusercontent.com";

/* ----------------------
   Scroll handling for header and info blocks
   ---------------------- */
let lastScrollTop = 0;
const header = document.querySelector('header');
const infoBlocks = document.getElementById('infoBlocks');
const tabs = document.getElementById('tabs');
const SCROLL_THRESHOLD = 200;

window.addEventListener('scroll', () => {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  // Header hide/show on scroll
  if (scrollTop > lastScrollTop && scrollTop > SCROLL_THRESHOLD) {
    header.classList.add('hidden');
  } else {
    header.classList.remove('hidden');
  }
  
  // Hide info blocks and tabs when scrolling to form
  if (scrollTop > 300) {
    infoBlocks.classList.add('hidden');
    tabs.classList.add('hidden');
  } else {
    infoBlocks.classList.remove('hidden');
    tabs.classList.remove('hidden');
  }
  
  lastScrollTop = scrollTop;
});

/* ----------------------
   helpers
   ---------------------- */
function parseJwt(token){
  try{
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c=>'%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload);
  }catch(e){
    return null;
  }
}

/* ----------------------
   welcome overlay
   ---------------------- */
function showWelcome(name, picture){
  const ov = document.getElementById('welcomeOverlay');
  const txt = document.getElementById('welcomeText');
  const av = document.getElementById('welcomeAvatar');
  txt.textContent = \`Welcome, \${name}\`;
  av.src = picture || '';
  ov.classList.add('show');
  // hide after 2s with smooth transition
  setTimeout(()=> ov.classList.remove('show'), 2000);
}

/* ----------------------
   Update UI for signed-in user
   ---------------------- */
function setSignedInUI(userObj, showWelcomeFlag){
  // top area
  const top = document.getElementById('topUserArea');
  top.innerHTML = ''; // clear

  // Extract first name only
  const firstName = userObj.name.split(' ')[0];

  // Show user chip in header
  const chip = document.createElement('div');
  chip.className = 'user-chip';
  chip.innerHTML = \`
    <img src="\${userObj.picture}" class="avatar" alt="Profile">
    <div class="user-info">
      <div class="user-name">\${firstName}</div>
      <div class="user-email">\${userObj.email}</div>
    </div>
  \`;
  top.appendChild(chip);

  // Show profile inside signin card
  document.getElementById('signedInInfo').style.display = 'block';
  document.getElementById('profilePic').src = userObj.picture || '';
  document.getElementById('displayName').textContent = firstName || '';
  document.getElementById('displayEmail').textContent = userObj.email || '';

  // show sign out button
  document.getElementById('signoutBtn').style.display = 'inline-block';

  // hide signin button container
  document.getElementById('g_id_signin_container').innerHTML = '';

  if(showWelcomeFlag) showWelcome(firstName, userObj.picture);
}

/* ----------------------
   Sign out function - FIXED
   ---------------------- */
function signOut(){
  console.log('Sign out clicked'); // Debug log

  // Clear stored user data
  localStorage.removeItem('rivava_user');

  // Hide signed-in UI elements
  document.getElementById('signedInInfo').style.display = 'none';
  document.getElementById('signoutBtn').style.display = 'none';

  // Clear top area user info
  document.getElementById('topUserArea').innerHTML = '';

  // Revoke Google sign-in session
  if(window.google && google.accounts && google.accounts.id){
    google.accounts.id.disableAutoSelect();
  }

  // Re-render signin button
  setTimeout(() => {
    renderSignIn();
  }, 100);

  // Optional: Clear the data table as well
  document.querySelector("#dataTable tbody").innerHTML = '';
  updateTotalExpense();

  console.log('User signed out successfully');
}

/* ----------------------
   Render Google Sign-in button (GSI)
   ---------------------- */
function renderSignIn(){
  const container = document.getElementById('g_id_signin_container');
  container.innerHTML = ''; // clear

  // if already initialized, render
  if(window.google && google.accounts && google.accounts.id){
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleCredentialResponse,
      auto_select: false,  // changed to false for better UX
      ux_mode: 'popup'
    });
    google.accounts.id.renderButton(
      container,
      {
        theme: 'outline',
        size: 'large',
        type: 'standard',
        text: 'signin_with',
        shape: 'rounded',
        logo_alignment: 'left'
      }
    );
  } else {
    // library not ready yet; try again shortly
    setTimeout(renderSignIn, 300);
  }
}

/* ----------------------
   Callback after sign-in
   ---------------------- */
function handleCredentialResponse(response){
  const payload = parseJwt(response.credential);
  if(!payload || !payload.email){
    console.error('Invalid ID token payload', payload);
    return;
  }
  // store minimal user info and token
  const user = {
    name: payload.name,
    email: payload.email,
    picture: payload.picture,
    token: response.credential,
    sub: payload.sub
  };
  localStorage.setItem('rivava_user', JSON.stringify(user));
  setSignedInUI(user, true);
}

/* ----------------------
   On load: check stored user or initialize sign-in
   ---------------------- */
window.addEventListener('load', ()=> {
  // init UI components
  setFixedDate();
  startLiveTime();

  // restore user if exists
  const s = localStorage.getItem('rivava_user');
  if(s){
    try{
      const user = JSON.parse(s);
      setSignedInUI(user, true);
    }catch(e){
      console.warn('restore user failed',e);
      localStorage.removeItem('rivava_user');
      renderSignIn();
    }
  } else {
    renderSignIn();
  }
});

/* ----------------------
   Form JS (original logic preserved)
   ---------------------- */
function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
  document.querySelector(\`.tab[onclick="showTab('\${tab}')"]\`).classList.add('active');
  document.getElementById(tab).classList.add('active');
}

function setFixedDate() {
  const today = new Date();
  const day = String(today.getDate()).padStart(2, "0");
  const month = String(today.getMonth() + 1).padStart(2, "0");
  const year = today.getFullYear();
  const formatted = \`\${day}/\${month}/\${year}\`;
  document.getElementById("fixedDate").textContent = formatted;
  return formatted;
}

function formatTime12Hour(date) {
  let hours = date.getHours();
  let minutes = date.getMinutes().toString().padStart(2, "0");
  let seconds = date.getSeconds().toString().padStart(2, "0");
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12; // the hour '0' should be '12'
  return \`\${hours}:\${minutes}:\${seconds} \${ampm}\`;
}

function startLiveTime() {
  const timeEl = document.getElementById("liveTime");
  function update() {
    const now = new Date();
    timeEl.textContent = formatTime12Hour(now);
  }
  update();
  setInterval(update, 1000);
}

// Data Table and total expense logic
const dataTableBody = document.querySelector("#dataTable tbody");
let totalExpense = 0;

function updateTotalExpense() {
  let sum = 0;
  dataTableBody.querySelectorAll("tr").forEach(row => {
    const type = row.cells[0].textContent;
    if (type === "Expense") {
      const amt = parseFloat(row.cells[1].textContent);
      if (!isNaN(amt)) sum += amt;
    }
  });
  totalExpense = sum;
  document.getElementById("totalExpense").textContent = \`₹\${totalExpense.toFixed(2)}\`;
}

function addRow(type, amount, category, payment, date, time) {
  const row = document.createElement("tr");
  // Format time to 12-hour format for display
  const timeObj = new Date();
  const [hours, minutes, seconds] = time.split(':');
  timeObj.setHours(parseInt(hours), parseInt(minutes), parseInt(seconds));
  const formattedTime = formatTime12Hour(timeObj);
  
  row.innerHTML = \`
    <td>\${type}</td>
    <td>\${parseFloat(amount).toFixed(2)}</td>
    <td>\${category}</td>
    <td>\${payment}</td>
    <td>\${date}</td>
    <td>\${formattedTime}</td>
    <td><button onclick="deleteRow(this)" aria-label="Delete this \${type.toLowerCase()} entry">Delete</button></td>
  \`;
  dataTableBody.appendChild(row);
  updateTotalExpense();
}

function deleteRow(button) {
  button.closest("tr").remove();
  updateTotalExpense();
}

function handleCategoryChange() {
  const categorySelect = document.getElementById("expenseCategory");
  const customInput = document.getElementById("customCategory");
  if (categorySelect.value === "Other") {
    customInput.style.display = "block";
    customInput.focus();
  } else {
    customInput.style.display = "none";
    customInput.value = "";
  }
}

function addEarning() {
  const amountInput = document.getElementById("earningAmount");
  const amount = amountInput.value.trim();
  if (!amount || Number(amount) <= 0) {
    alert("Please enter a valid earning amount.");
    return;
  }
  const date = document.getElementById("fixedDate").textContent;
  const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  addRow("Earning", amount, "-", "-", date, time);
  amountInput.value = "";
}

function addExpense() {
  const amountInput = document.getElementById("expenseAmount");
  const amount = amountInput.value.trim();
  if (!amount || Number(amount) <= 0) {
    alert("Please enter a valid expense amount.");
    return;
  }

  const categorySelect = document.getElementById("expenseCategory");
  let category = categorySelect.value;

  if (category === "Other") {
    const customCat = document.getElementById("customCategory").value.trim();
    if (!customCat) {
      alert("Please enter a custom category.");
      return;
    }
    category = customCat;
  }

  const payment = document.getElementById("paymentMethod").value;
  const date = document.getElementById("fixedDate").textContent;
  const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  addRow("Expense", amount, category, payment, date, time);
  amountInput.value = "";

  // Reset the custom input & select if needed
  if (categorySelect.value === "Other") {
    document.getElementById("customCategory").value = "";
    document.getElementById("customCategory").style.display = "none";
    categorySelect.value = "Personal"; // Reset to first option
  }
}

// ✅ MODIFIED submitForm to use Firebase with enhanced UI
async function submitForm() {
  console.log("=== Starting submitForm (Firebase version) ===");

  if (dataTableBody.children.length === 0) {
    showConfirmation("Please add some earnings or expenses before submitting.", true);
    console.warn("Submit clicked but no data in table.");
    return;
  }

  const stored = localStorage.getItem('rivava_user');
  if (!stored) {
    showConfirmation("You must sign in first.", true);
    console.warn("Submit clicked but user not signed in.");
    return;
  }

  const user = JSON.parse(stored);
  console.log("Signed in user:", user.email);

  const rows = [];
  dataTableBody.querySelectorAll('tr').forEach(r => {
    rows.push({
      type: r.cells[0].textContent.trim(),
      amount: parseFloat(r.cells[1].textContent.trim()),
      category: r.cells[2].textContent.trim(),
      payment: r.cells[3].textContent.trim(),
      date: r.cells[4].textContent.trim(),
      time: r.cells[5].textContent.trim()
    });
  });

  // Prepare the data payload exactly as before
  const payload = {
    userEmail: user.email,
    userName: user.name, // Optional
    transactions: rows,
    submittedAt: firebase.firestore.FieldValue.serverTimestamp() // Add server timestamp
  };

  console.log("Prepared payload to send to Firebase:");
  console.log(JSON.stringify(payload, null, 2)); // Log the payload for debugging

  try {
    console.log("Attempting to send data to Firebase Firestore...");
    // Use Firebase Firestore to add the data
    const docRef = await db.collection('submissions').add(payload);

    console.log("Data successfully written to Firebase with ID: ", docRef.id);

    // Show success message with animation
    showConfirmation("✅ Data submitted successfully to Firebase!", false);

    // Optional: Clear the form table after successful submission
    // dataTableBody.innerHTML = '';
    // updateTotalExpense();

  } catch (error) {
    // Handle any errors that occurred during the Firestore operation
    console.error("Error submitting data to Firebase:", error);
    showConfirmation("❌ Failed to save data to Firebase. Please check the browser console for details.", true);
  }

  console.log("=== Finished submitForm (Firebase version) ===");
}

// Enhanced confirmation message with animations
function showConfirmation(message, isError) {
  const msg = document.getElementById("confirmationMessage");
  msg.textContent = message;
  msg.className = "confirmation";
  if (isError) {
    msg.classList.add("error");
  }
  
  // Show with animation
  setTimeout(() => {
    msg.style.display = "block";
    // Scroll to top to see message
    window.scrollTo({ top: 0, behavior: "smooth" });
  }, 10);
  
  // Auto hide after 3 seconds
  setTimeout(() => {
    msg.style.display = "none";
  }, 3000);
}

// Add touch events for better mobile experience
document.addEventListener('touchstart', function() {}, {passive: true});
</script>

</body>
</html>
