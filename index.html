<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<title>Rivava Finance Tracker</title>

<!-- Fonts & Google Identity lib -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  :root{
    --bg-primary:#0a0a0b;
    --bg-secondary:#111115;
    --bg-tertiary:#1a1a1f;
    --accent-primary:#00ff88;
    --accent-secondary:#00cc6a;
    --accent-glow:rgba(0,255,136,0.15);
    --text-primary:#ffffff;
    --text-secondary:#a1a1aa;
    --text-muted:#71717a;
    --border-primary:#27272a;
    --border-secondary:#3f3f46;
    --success:#22c55e;
    --error:#ef4444;
    --warning:#f59e0b;
    --shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow:0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1);
    --radius-sm:6px;
    --radius:12px;
    --radius-lg:16px;
    --transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
    --transition-bounce:all 0.3s cubic-bezier(0.68,-0.55,0.265,1.55);
  }

  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
  }

  body{
    font-family:'Inter',system-ui,-apple-system,sans-serif;
    background:var(--bg-primary);
    color:var(--text-primary);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.5;
    min-height:100vh;
    overflow-x:hidden;
  }

  /* Smooth scroll */
  html{scroll-behavior:smooth}

  /* Enhanced Header with Glass Effect */
  header{
    position:sticky;
    top:0;
    z-index:100;
    backdrop-filter:blur(20px);
    -webkit-backdrop-filter:blur(20px);
    background:rgba(10,10,11,0.9);
    border-bottom:1px solid var(--border-primary);
    padding:12px 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    transition:var(--transition);
    height:60px;
  }

  .brand {
    display:flex;
    align-items:center;
    gap:10px;
    animation:slideInLeft 0.6s ease-out;
  }

  .logo {
    width:36px;
    height:36px;
    border-radius:var(--radius-sm);
    background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));
    display:flex;
    align-items:center;
    justify-content:center;
    color:#000;
    font-weight:700;
    font-size:1rem;
    box-shadow:0 4px 16px var(--accent-glow);
    transition:var(--transition-bounce);
    cursor:pointer;
  }

  .logo:hover{
    transform:scale(1.05);
    box-shadow:0 6px 24px var(--accent-glow);
  }

  .brand-text {
    font-size:1.25rem;
    font-weight:700;
    background:linear-gradient(90deg,var(--accent-primary),var(--text-primary));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }

  /* Top User Area */
  .top-user-chip{
    display:flex;
    align-items:center;
    gap:8px;
    background:var(--bg-secondary);
    padding:6px 12px;
    border-radius:20px;
    border:1px solid var(--border-primary);
    backdrop-filter:blur(10px);
    transition:var(--transition);
    animation:slideInRight 0.6s ease-out;
    max-width:200px;
  }

  .top-user-chip:hover{
    background:var(--bg-tertiary);
    border-color:var(--border-secondary);
  }

  .top-user-avatar{
    width:28px;
    height:28px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid var(--accent-primary);
    flex-shrink:0;
  }

  .top-user-info{
    display:flex;
    flex-direction:column;
    min-width:0;
    flex:1;
  }

  .top-user-name{
    font-weight:600;
    font-size:0.8rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    line-height:1.2;
  }

  .top-user-email{
    font-size:0.7rem;
    color:var(--text-muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    line-height:1.2;
  }

  /* Modern Signin Card */
  .signin-container{
    padding:16px;
    max-width:400px;
    margin:0 auto;
    animation:fadeInUp 0.8s ease-out;
  }

  .signin-card{
    background:linear-gradient(145deg,var(--bg-secondary),var(--bg-tertiary));
    border:1px solid var(--border-primary);
    border-radius:var(--radius-lg);
    padding:24px;
    text-align:center;
    backdrop-filter:blur(20px);
    box-shadow:var(--shadow-lg);
    position:relative;
    overflow:hidden;
    transition:var(--transition);
  }

  .signin-card::before{
    content:'';
    position:absolute;
    top:0;
    left:0;
    right:0;
    height:1px;
    background:linear-gradient(90deg,transparent,var(--accent-primary),transparent);
    opacity:0.6;
  }

  .signin-card:hover{
    transform:translateY(-2px);
    box-shadow:0 20px 40px rgba(0,0,0,0.15);
    border-color:var(--border-secondary);
  }

  .signin-title{
    font-size:1.25rem;
    font-weight:700;
    margin-bottom:8px;
    background:linear-gradient(135deg,var(--text-primary),var(--text-secondary));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }

  .signin-subtitle{
    color:var(--text-secondary);
    margin-bottom:24px;
    line-height:1.5;
    font-size:0.9rem;
  }

  .signed-in-profile{
    display:none;
    text-align:center;
    animation:scaleIn 0.4s ease-out;
  }

  .profile-avatar{
    width:60px;
    height:60px;
    border-radius:50%;
    object-fit:cover;
    margin:0 auto 12px;
    border:3px solid var(--accent-primary);
    box-shadow:0 4px 16px var(--accent-glow);
  }

  .profile-name{
    font-size:1.1rem;
    font-weight:600;
    margin-bottom:4px;
  }

  .profile-email{
    color:var(--text-secondary);
    font-size:0.85rem;
    margin-bottom:20px;
  }

  /* Enhanced Buttons */
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:10px 18px;
    border-radius:var(--radius-sm);
    font-weight:600;
    font-size:0.9rem;
    border:none;
    cursor:pointer;
    transition:var(--transition-bounce);
    position:relative;
    overflow:hidden;
    text-decoration:none;
    white-space:nowrap;
    min-height:40px;
  }

  .btn::before{
    content:'';
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:linear-gradient(45deg,transparent,rgba(255,255,255,0.1),transparent);
    transform:translateX(-100%);
    transition:transform 0.6s ease;
  }

  .btn:hover::before{
    transform:translateX(100%);
  }

  .btn-primary{
    background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));
    color:#000;
    box-shadow:0 2px 8px var(--accent-glow);
  }

  .btn-primary:hover{
    transform:translateY(-1px) scale(1.02);
    box-shadow:0 4px 16px var(--accent-glow);
  }

  .btn-primary:active{
    transform:translateY(0) scale(0.98);
  }

  .btn-secondary{
    background:var(--bg-tertiary);
    color:var(--text-primary);
    border:1px solid var(--border-secondary);
  }

  .btn-secondary:hover{
    background:var(--border-secondary);
    transform:translateY(-1px);
  }

  .btn-danger{
    background:linear-gradient(135deg,#ff6b6b,#ee5a52);
    color:white;
    box-shadow:0 2px 8px rgba(255,107,107,0.3);
  }

  .btn-danger:hover{
    transform:translateY(-1px);
    box-shadow:0 4px 16px rgba(255,107,107,0.4);
  }

  /* Main Content */
  .main-container{
    max-width:400px;
    margin:0 auto;
    padding:16px;
    animation:fadeInUp 1s ease-out;
  }

  /* Stats Cards */
  .stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:16px;
    margin-bottom:32px;
  }

  .stat-card{
    background:var(--bg-secondary);
    border:1px solid var(--border-primary);
    border-radius:var(--radius-lg);
    padding:20px;
    text-align:center;
    transition:var(--transition);
    position:relative;
    overflow:hidden;
  }

  .stat-card::before{
    content:'';
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:2px;
    background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary));
    transform:scaleX(0);
    transition:transform 0.3s ease;
  }

  .stat-card:hover::before{
    transform:scaleX(1);
  }

  .stat-card:hover{
    transform:translateY(-4px);
    box-shadow:var(--shadow-lg);
    border-color:var(--border-secondary);
  }

  .stat-label{
    font-size:0.85rem;
    color:var(--text-secondary);
    font-weight:500;
    margin-bottom:8px;
  }

  .stat-value{
    font-size:1.5rem;
    font-weight:700;
    color:var(--accent-primary);
    font-family:'Inter',monospace;
  }

  /* Enhanced Tabs */
  .tabs-container{
    background:var(--bg-secondary);
    border-radius:var(--radius-lg);
    padding:6px;
    margin-bottom:24px;
    border:1px solid var(--border-primary);
    position:relative;
  }

  .tabs{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:4px;
    position:relative;
  }

  .tab{
    padding:16px;
    text-align:center;
    font-weight:600;
    border-radius:var(--radius);
    cursor:pointer;
    transition:var(--transition);
    position:relative;
    z-index:2;
  }

  .tab.active{
    color:#000;
    background:var(--accent-primary);
    box-shadow:0 4px 12px var(--accent-glow);
  }

  .tab:not(.active){
    color:var(--text-secondary);
  }

  .tab:not(.active):hover{
    color:var(--text-primary);
    background:var(--bg-tertiary);
  }

  /* Form Sections */
  .form-section{
    display:none;
    background:var(--bg-secondary);
    border:1px solid var(--border-primary);
    border-radius:var(--radius-lg);
    padding:24px;
    animation:slideInUp 0.4s ease-out;
  }

  .form-section.active{
    display:block;
  }

  .form-group{
    margin-bottom:20px;
  }

  .form-label{
    display:block;
    font-weight:600;
    font-size:0.9rem;
    color:var(--text-primary);
    margin-bottom:8px;
  }

  .form-input{
    width:100%;
    padding:16px;
    border-radius:var(--radius);
    background:var(--bg-tertiary);
    border:1px solid var(--border-primary);
    color:var(--text-primary);
    font-size:16px;
    transition:var(--transition);
    font-family:inherit;
  }

  .form-input:focus{
    outline:none;
    border-color:var(--accent-primary);
    box-shadow:0 0 0 3px var(--accent-glow);
    background:var(--bg-primary);
  }

  .form-input::placeholder{
    color:var(--text-muted);
  }

  /* Enhanced Table */
  .table-container{
    background:var(--bg-secondary);
    border:1px solid var(--border-primary);
    border-radius:var(--radius-lg);
    overflow:hidden;
    margin:24px 0;
  }

  .table-wrapper{
    overflow-x:auto;
    max-height:400px;
    overflow-y:auto;
  }

  table{
    width:100%;
    border-collapse:collapse;
    min-width:600px;
  }

  th{
    background:var(--bg-tertiary);
    padding:16px 12px;
    text-align:left;
    font-weight:600;
    font-size:0.85rem;
    color:var(--accent-primary);
    border-bottom:1px solid var(--border-primary);
    position:sticky;
    top:0;
    z-index:1;
  }

  td{
    padding:16px 12px;
    border-bottom:1px solid var(--border-primary);
    font-size:0.9rem;
    vertical-align:middle;
  }

  tbody tr{
    transition:var(--transition);
  }

  tbody tr:hover{
    background:var(--bg-tertiary);
  }

  .delete-btn{
    padding:6px 12px;
    background:var(--error);
    color:white;
    border:none;
    border-radius:var(--radius-sm);
    font-size:0.8rem;
    cursor:pointer;
    transition:var(--transition);
  }

  .delete-btn:hover{
    background:#dc2626;
    transform:scale(1.05);
  }

  /* Empty State */
  .empty-state{
    text-align:center;
    padding:60px 20px;
    color:var(--text-muted);
  }

  .empty-icon{
    font-size:3rem;
    margin-bottom:16px;
    opacity:0.5;
  }

  /* Success Message */
  .success-message{
    display:none;
    background:linear-gradient(135deg,var(--success),#16a34a);
    color:white;
    padding:16px;
    border-radius:var(--radius);
    text-align:center;
    margin:24px 0;
    font-weight:600;
    animation:slideInUp 0.4s ease-out;
  }

  /* Welcome Toast */
  .welcome-toast{
    position:fixed;
    top:100px;
    left:50%;
    transform:translateX(-50%) translateY(-20px);
    background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));
    color:#000;
    padding:16px 24px;
    border-radius:50px;
    display:flex;
    align-items:center;
    gap:12px;
    font-weight:600;
    box-shadow:0 20px 40px rgba(0,255,136,0.3);
    z-index:1000;
    opacity:0;
    pointer-events:none;
    transition:all 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);
  }

  .welcome-toast.show{
    opacity:1;
    transform:translateX(-50%) translateY(0);
  }

  .welcome-avatar{
    width:40px;
    height:40px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid rgba(0,0,0,0.2);
  }

  /* Loading States */
  .loading{
    opacity:0.7;
    pointer-events:none;
    position:relative;
  }

  .loading::after{
    content:'';
    position:absolute;
    top:50%;
    left:50%;
    width:20px;
    height:20px;
    margin:-10px 0 0 -10px;
    border:2px solid var(--accent-primary);
    border-top-color:transparent;
    border-radius:50%;
    animation:spin 1s linear infinite;
  }

  /* Animations */
  @keyframes fadeInUp{
    from{opacity:0;transform:translateY(30px)}
    to{opacity:1;transform:translateY(0)}
  }

  @keyframes slideInLeft{
    from{opacity:0;transform:translateX(-30px)}
    to{opacity:1;transform:translateX(0)}
  }

  @keyframes slideInRight{
    from{opacity:0;transform:translateX(30px)}
    to{opacity:1;transform:translateX(0)}
  }

  @keyframes slideInUp{
    from{opacity:0;transform:translateY(20px)}
    to{opacity:1;transform:translateY(0)}
  }

  @keyframes scaleIn{
    from{opacity:0;transform:scale(0.9)}
    to{opacity:1;transform:scale(1)}
  }

  @keyframes spin{
    to{transform:rotate(360deg)}
  }

  @keyframes pulse{
    0%,100%{opacity:1}
    50%{opacity:0.5}
  }

  /* Mobile Optimizations */
  @media (max-width: 640px) {
    header{
      padding:8px 16px;
      height:52px;
    }

    .logo{
      width:28px;
      height:28px;
      font-size:0.9rem;
    }

    .brand-text{
      font-size:1.1rem;
    }

    .top-user-chip{
      padding:4px 8px;
      gap:6px;
      max-width:140px;
    }

    .top-user-avatar{
      width:24px;
      height:24px;
      border-width:1px;
    }

    .top-user-name{
      font-size:0.75rem;
    }

    .top-user-email{
      font-size:0.65rem;
    }

    .signin-container{
      padding:12px;
    }

    .signin-card{
      padding:20px 16px;
    }

    .signin-title{
      font-size:1.1rem;
    }

    .signin-subtitle{
      font-size:0.85rem;
    }

    .profile-avatar{
      width:50px;
      height:50px;
      border-width:2px;
    }

    .profile-name{
      font-size:1rem;
    }

    .profile-email{
      font-size:0.8rem;
    }

    .main-container{
      padding:12px;
    }

    .stats-grid{
      grid-template-columns:1fr;
      gap:10px;
      margin-bottom:20px;
    }

    .stat-card{
      padding:14px;
    }

    .stat-value{
      font-size:1.25rem;
    }

    .form-section{
      padding:16px;
    }

    .form-input{
      padding:12px;
      font-size:16px;
    }

    .btn{
      padding:12px 16px;
      font-size:0.95rem;
    }

    th,td{
      padding:10px 6px;
      font-size:0.8rem;
    }

    table{
      min-width:450px;
    }

    .welcome-toast{
      left:12px;
      right:12px;
      transform:translateX(0) translateY(-20px);
      border-radius:var(--radius);
      padding:12px 16px;
    }

    .welcome-toast.show{
      transform:translateX(0) translateY(0);
    }

    .welcome-avatar{
      width:32px;
      height:32px;
    }
  }

  /* Ultra small devices */
  @media (max-width: 375px) {
    header{
      padding:6px 12px;
      height:48px;
    }

    .logo{
      width:24px;
      height:24px;
      font-size:0.8rem;
    }

    .brand-text{
      font-size:1rem;
    }

    .top-user-chip{
      padding:3px 6px;
      gap:4px;
      max-width:120px;
      border-radius:16px;
    }

    .top-user-avatar{
      width:20px;
      height:20px;
    }

    .top-user-name{
      font-size:0.7rem;
    }

    .top-user-email{
      display:none;
    }

    .signin-card{
      padding:16px 12px;
    }

    .main-container{
      padding:8px;
    }

    .form-section{
      padding:12px;
    }

    .btn{
      padding:10px 14px;
      font-size:0.9rem;
    }

    .stat-card{
      padding:12px;
    }

    .welcome-toast{
      padding:10px 12px;
      font-size:0.85rem;
    }
  }

  /* Dark scrollbar for all elements */
  *::-webkit-scrollbar{
    width:8px;
    height:8px;
  }

  *::-webkit-scrollbar-track{
    background:var(--bg-secondary);
  }

  *::-webkit-scrollbar-thumb{
    background:var(--border-secondary);
    border-radius:4px;
  }

  *::-webkit-scrollbar-thumb:hover{
    background:var(--text-muted);
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    *,::before,::after{
      animation-duration:0.01ms !important;
      animation-iteration-count:1 !important;
      transition-duration:0.01ms !important;
    }
  }

  /* High contrast for accessibility */
  @media (prefers-contrast: high) {
    :root{
      --border-primary:#666;
      --border-secondary:#999;
      --text-secondary:#ccc;
    }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">R</div>
    <div class="brand-text">RIVAVA</div>
  </div>
  <div id="topUserArea"></div>
</header>

<!-- Signin Section -->
<div class="signin-container" id="signinContainer">
  <div class="signin-card">
    <div class="signin-title">Welcome to Rivava Finance</div>
    <div class="signin-subtitle">Track your earnings and expenses with secure authentication</div>
    
    <div id="signedInInfo" class="signed-in-profile">
      <img id="profilePic" class="profile-avatar" src="" alt="Profile">
      <div class="profile-name" id="displayName"></div>
      <div class="profile-email" id="displayEmail"></div>
      <button id="signoutBtn" class="btn btn-danger" onclick="signOut()">
        <span>Sign out</span>
      </button>
    </div>
    
    <div id="g_id_signin_container"></div>
  </div>
</div>

<!-- Main App -->
<div class="main-container">
  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Expense</div>
      <div class="stat-value" id="totalExpense">₹0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Time</div>
      <div class="stat-value" id="liveTime">--:--:--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Date</div>
      <div class="stat-value" id="fixedDate">--/--/----</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <div class="tabs">
      <div class="tab active" onclick="showTab('earning')">💰 Earning</div>
      <div class="tab" onclick="showTab('expense')">💸 Expense</div>
    </div>
  </div>

  <!-- Earning Form -->
  <div id="earning" class="form-section active">
    <div class="form-group">
      <label class="form-label">Amount</label>
      <input type="number" id="earningAmount" class="form-input" placeholder="Enter earning amount" min="0" step="0.01" />
    </div>
    <button class="btn btn-primary" onclick="addEarning()">Add Earning</button>
  </div>

  <!-- Expense Form -->
  <div id="expense" class="form-section">
    <div class="form-group">
      <label class="form-label">Category</label>
      <select id="expenseCategory" class="form-input" onchange="handleCategoryChange()">
        <option value="Personal">Personal</option>
        <option value="Food">Food</option>
        <option value="Transport">Transport</option>
        <option value="Shopping">Shopping</option>
        <option value="Recharge and Bills">Recharge and Bills</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div class="form-group" id="customCategoryGroup" style="display:none;">
      <label class="form-label">Custom Category</label>
      <input type="text" id="customCategory" class="form-input" placeholder="Enter custom category" />
    </div>

    <div class="form-group">
      <label class="form-label">Amount</label>
      <input type="number" id="expenseAmount" class="form-input" placeholder="Enter expense amount" min="0" step="0.01" />
    </div>

    <div class="form-group">
      <label class="form-label">Payment Method</label>
      <select id="paymentMethod" class="form-input">
        <option value="UPI">UPI</option>
        <option value="Cash">Cash</option>
        <option value="Credit Card">Credit Card</option>
        <option value="Bank Transfer">Bank Transfer</option>
      </select>
    </div>

    <button class="btn btn-primary" onclick="addExpense()">Add Expense</button>
  </div>

  <!-- Transactions Table -->
  <div class="table-container">
    <div class="table-wrapper">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Amount</th>
            <th>Category</th>
            <th>Payment</th>
            <th>Date</th>
            <th>Time</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr class="empty-state">
            <td colspan="7">
              <div class="empty-icon">📊</div>
              <div>No transactions yet. Add your first transaction above!</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <button id="submitBtn" class="btn btn-primary" onclick="submitForm()">Submit Data</button>

  <div id="confirmationMessage" class="success-message">
    ✅ Thank you! Your data has been submitted successfully.
  </div>
</div>

<!-- Welcome Toast -->
<div id="welcomeToast" class="welcome-toast">
  <img id="welcomeAvatar" class="welcome-avatar" src="" alt="">
  <div id="welcomeText"></div>
</div>

<script>
/* ----------------------
   CONFIG
   ---------------------- */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec";
const GOOGLE_CLIENT_ID = "151251461452-qooai71ob9njlduadhpqr55kuf5hfb40.apps.googleusercontent.com";

/* ----------------------
   Utilities
   ---------------------- */
function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload);
  } catch (e) {
    return null;
  }
}

function showToast(message, type = 'success', duration = 3000) {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    z-index: 1000;
    animation: slideInRight 0.3s ease-out;
    background: ${type === 'success' ? 'var(--success)' : 'var(--error)'};
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  `;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

/* ----------------------
   Welcome Toast
   ---------------------- */
function showWelcome(name, picture) {
  const toast = document.getElementById('welcomeToast');
  const text = document.getElementById('welcomeText');
  const avatar = document.getElementById('welcomeAvatar');
  
  text.textContent = `Welcome back, ${name}! 👋`;
  avatar.src = picture || '';
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

/* ----------------------
   Auth Functions
   ---------------------- */
function setSignedInUI(userObj, showWelcomeFlag) {
  // Top area user chip
  const topArea = document.getElementById('topUserArea');
  topArea.innerHTML = '';
  
  const chip = document.createElement('div');
  chip.className = 'top-user-chip';
  chip.innerHTML = `
    <img src="${userObj.picture}" class="top-user-avatar" alt="Profile">
    <div class="top-user-info">
      <div class="top-user-name">${userObj.name}</div>
      <div class="top-user-email">${userObj.email}</div>
    </div>
  `;
  topArea.appendChild(chip);

  // Show profile in signin card
  document.getElementById('signedInInfo').style.display = 'block';
  document.getElementById('profilePic').src = userObj.picture || '';
  document.getElementById('displayName').textContent = userObj.name || '';
  document.getElementById('displayEmail').textContent = userObj.email || '';
  document.getElementById('signoutBtn').style.display = 'inline-flex';

  // Hide signin button
  document.getElementById('g_id_signin_container').innerHTML = '';

  if (showWelcomeFlag) showWelcome(userObj.name, userObj.picture);
}

function signOut() {
  console.log('Sign out clicked');
  
  // Clear stored user data
  localStorage.removeItem('rivava_user');
  
  // Hide signed-in UI elements
  document.getElementById('signedInInfo').style.display = 'none';
  document.getElementById('signoutBtn').style.display = 'none';
  
  // Clear top area user info
  document.getElementById('topUserArea').innerHTML = '';
  
  // Revoke Google sign-in session
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.disableAutoSelect();
  }
  
  // Re-render signin button
  setTimeout(() => {
    renderSignIn();
  }, 100);
  
  console.log('User signed out successfully');
}

function renderSignIn() {
  const container = document.getElementById('g_id_signin_container');
  container.innerHTML = '';
  
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleCredentialResponse,
      auto_select: false,
      ux_mode: 'popup'
    });
    google.accounts.id.renderButton(
      container,
      { 
        theme: 'outline', 
        size: 'large', 
        type: 'standard', 
        text: 'signin_with',
        shape: 'rounded',
        logo_alignment: 'left'
      }
    );
  } else {
    setTimeout(renderSignIn, 300);
  }
}

function handleCredentialResponse(response) {
  const payload = parseJwt(response.credential);
  if (!payload || !payload.email) {
    console.error('Invalid ID token payload', payload);
    return;
  }
  
  const user = {
    name: payload.name,
    email: payload.email,
    picture: payload.picture,
    token: response.credential,
    sub: payload.sub
  };
  localStorage.setItem('rivava_user', JSON.stringify(user));
  setSignedInUI(user, true);
}

/* ----------------------
   Date & Time Functions
   ---------------------- */
function setFixedDate() {
  const today = new Date();
  const day = String(today.getDate()).padStart(2, "0");
  const month = String(today.getMonth() + 1).padStart(2, "0");
  const year = today.getFullYear();
  const formatted = `${day}/${month}/${year}`;
  document.getElementById("fixedDate").textContent = formatted;
  return formatted;
}

function startLiveTime() {
  const timeEl = document.getElementById("liveTime");
  function update() {
    const now = new Date();
    const h = now.getHours().toString().padStart(2, "0");
    const m = now.getMinutes().toString().padStart(2, "0");
    const s = now.getSeconds().toString().padStart(2, "0");
    timeEl.textContent = `${h}:${m}:${s}`;
  }
  update();
  setInterval(update, 1000);
}

/* ----------------------
   Initialize App
   ---------------------- */
window.addEventListener('load', () => {
  // Initialize date & time
  setFixedDate();
  startLiveTime();
  
  // Check for stored user
  const stored = localStorage.getItem('rivava_user');
  if (stored) {
    try {
      const user = JSON.parse(stored);
      setSignedInUI(user, true);
    } catch (e) {
      console.warn('restore user failed', e);
      localStorage.removeItem('rivava_user');
      renderSignIn();
    }
  } else {
    renderSignIn();
  }
});

/* ----------------------
   Form Functions
   ---------------------- */
const dataTableBody = document.querySelector("#dataTable tbody");
let totalExpense = 0;

function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
  document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(tab).classList.add('active');
}

function updateTotalExpense() {
  let sum = 0;
  dataTableBody.querySelectorAll("tr").forEach(row => {
    if (row.cells.length > 1) {
      const type = row.cells[0].textContent;
      if (type === "Expense") {
        const amt = parseFloat(row.cells[1].textContent);
        if (!isNaN(amt)) sum += amt;
      }
    }
  });
  totalExpense = sum;
  document.getElementById("totalExpense").textContent = `₹${totalExpense.toFixed(2)}`;
  
  // Hide empty state if we have data
  const emptyState = document.querySelector('.empty-state');
  if (dataTableBody.children.length > 1 && emptyState) {
    emptyState.remove();
  }
}

function addRow(type, amount, category, payment, date, time) {
  // Remove empty state if exists
  const emptyState = document.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }
  
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${type}</td>
    <td>${parseFloat(amount).toFixed(2)}</td>
    <td>${category}</td>
    <td>${payment}</td>
    <td>${date}</td>
    <td>${time}</td>
    <td><button class="delete-btn" onclick="deleteRow(this)" aria-label="Delete this ${type.toLowerCase()} entry">Delete</button></td>
  `;
  dataTableBody.appendChild(row);
  updateTotalExpense();
}

function deleteRow(button) {
  button.closest("tr").remove();
  updateTotalExpense();
  
  // Show empty state if no data
  if (dataTableBody.children.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.className = 'empty-state';
    emptyRow.innerHTML = `
      <td colspan="7">
        <div class="empty-icon">📊</div>
        <div>No transactions yet. Add your first transaction above!</div>
      </td>
    `;
    dataTableBody.appendChild(emptyRow);
  }
}

function handleCategoryChange() {
  const categorySelect = document.getElementById("expenseCategory");
  const customGroup = document.getElementById("customCategoryGroup");
  const customInput = document.getElementById("customCategory");
  
  if (categorySelect.value === "Other") {
    customGroup.style.display = "block";
    customInput.focus();
  } else {
    customGroup.style.display = "none";
    customInput.value = "";
  }
}

function addEarning() {
  const amountInput = document.getElementById("earningAmount");
  const amount = amountInput.value.trim();
  if (!amount || Number(amount) <= 0) {
    showToast("Please enter a valid earning amount.", 'error');
    return;
  }
  const date = document.getElementById("fixedDate").textContent;
  const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  addRow("Earning", amount, "-", "-", date, time);
  amountInput.value = "";
  showToast("Earning added successfully!", 'success');
}

function addExpense() {
  const amountInput = document.getElementById("expenseAmount");
  const amount = amountInput.value.trim();
  if (!amount || Number(amount) <= 0) {
    showToast("Please enter a valid expense amount.", 'error');
    return;
  }

  const categorySelect = document.getElementById("expenseCategory");
  let category = categorySelect.value;

  if (category === "Other") {
    const customCat = document.getElementById("customCategory").value.trim();
    if (!customCat) {
      showToast("Please enter a custom category.", 'error');
      return;
    }
    category = customCat;
  }

  const payment = document.getElementById("paymentMethod").value;
  const date = document.getElementById("fixedDate").textContent;
  const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  addRow("Expense", amount, category, payment, date, time);
  amountInput.value = "";

  // Reset custom category
  if (categorySelect.value === "Other") {
    document.getElementById("customCategory").value = "";
    document.getElementById("customCategoryGroup").style.display = "none";
    categorySelect.value = "Personal";
  }
  
  showToast("Expense added successfully!", 'success');
}

async function submitForm() {
  const rows = dataTableBody.querySelectorAll('tr:not(.empty-state)');
  if (rows.length === 0) {
    showToast("Please add some earnings or expenses before submitting.", 'error');
    return;
  }
  
  const msg = document.getElementById("confirmationMessage");
  msg.style.display = "block";
  setTimeout(() => {
    msg.style.display = "none";
  }, 3000);

  // Optional: send to backend if configured and user signed in
  const stored = localStorage.getItem('rivava_user');
  if (stored && APPS_SCRIPT_URL && !APPS_SCRIPT_URL.includes('YOUR_DEPLOY_ID')) {
    const user = JSON.parse(stored);
    const transactions = [];
    rows.forEach(r => {
      transactions.push({
        type: r.cells[0].textContent,
        amount: r.cells[1].textContent,
        category: r.cells[2].textContent,
        payment: r.cells[3].textContent,
        date: r.cells[4].textContent,
        time: r.cells[5].textContent
      });
    });

    const payload = {
      userEmail: user.email,
      userName: user.name,
      transactions: transactions,
      id_token: user.token
    };

    try {
      const res = await fetch(APPS_SCRIPT_URL, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(payload) 
      });
      const text = await res.text();
      console.log('Server response', res.status, text);
    } catch (e) {
      console.warn('Send failed', e);
    }
  }
}

// Add touch events for better mobile experience
document.addEventListener('touchstart', function() {}, {passive: true});
